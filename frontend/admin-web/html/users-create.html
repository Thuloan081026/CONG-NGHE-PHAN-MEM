<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Create User - SMD Admin</title>
  <link rel="shortcut icon" type="image/png" href="../assets/images/logos/favicon.png" />
  <link rel="stylesheet" href="../assets/css/styles.min.css" />
  <link rel="stylesheet" href="../assets/css/smd-custom.css" />
</head>

<body>
  <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
    data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    <aside class="left-sidebar">
      <div>
        <div class="brand-logo d-flex align-items-center justify-content-between">
          <a href="./dashboard.html" class="text-nowrap logo-img">
            <img src="../assets/images/logos/dark-logo.svg" width="180" alt="" />
          </a>
          <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
            <i class="ti ti-x fs-8"></i>
          </div>
        </div>
        <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
          <ul id="sidebarnav">
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">ADMIN PANEL</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./dashboard.html" aria-expanded="false">
                <span><i class="ti ti-layout-dashboard"></i></span>
                <span class="hide-menu">Dashboard</span>
              </a>
            </li>
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">USER MANAGEMENT</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./users-list.html" aria-expanded="false">
                <span><i class="ti ti-users"></i></span>
                <span class="hide-menu">User List</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link active" href="./users-create.html" aria-expanded="false">
                <span><i class="ti ti-user-plus"></i></span>
                <span class="hide-menu">Create User</span>
              </a>
            </li>            <li class="sidebar-item">
              <a class="sidebar-link" href="./users-import.html" aria-expanded="false">
                <span><i class="ti ti-file-upload"></i></span>
                <span class="hide-menu">Import Users</span>
              </a>
            </li>            <li class="sidebar-item">
              <a class="sidebar-link" href="./roles-permissions.html" aria-expanded="false">
                <span><i class="ti ti-lock"></i></span>
                <span class="hide-menu">Roles & Permissions</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
    <!--  Sidebar End -->
    
    <!--  Main wrapper -->
    <div class="body-wrapper">
      <!--  Header Start -->
      <header class="app-header">
        <nav class="navbar navbar-expand-lg navbar-light">
          <ul class="navbar-nav">
            <li class="nav-item d-block d-xl-none">
              <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
                <i class="ti ti-menu-2"></i>
              </a>
            </li>
          </ul>
          <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
            <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
              <li class="nav-item dropdown">
                <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
                  aria-expanded="false">
                  <img src="../assets/images/profile/user-1.jpg" alt="" width="35" height="35" class="rounded-circle">
                </a>
                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                  <div class="message-body">
                    <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                      <i class="ti ti-user fs-6"></i>
                      <p class="mb-0 fs-3">My Profile</p>
                    </a>
                    <a href="javascript:void(0)" onclick="logout()" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </nav>
      </header>
      <!--  Header End -->
      
      <div class="container-fluid">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="card-title fw-semibold mb-0">Create New User</h5>
              <a href="./users-list.html" class="btn btn-outline-secondary btn-sm">
                <i class="ti ti-arrow-left"></i> Back to List
              </a>
            </div>
            
            <div class="alert alert-danger d-none" id="errorMessage" role="alert"></div>
            <div class="alert alert-success d-none" id="successMessage" role="alert"></div>
            
            <form id="createUserForm">
              <h6 class="fw-semibold mb-3">Thông tin tài khoản</h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                  <input type="email" class="form-control" id="email" required placeholder="lecturer@smd.edu.vn">
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="employee_id" class="form-label">Mã số giảng viên <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="employee_id" required placeholder="VD: GV001, LEC2023001...">
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="fullName" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="fullName" required placeholder="Nguyễn Văn A">
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="role" class="form-label">Vai trò <span class="text-danger">*</span></label>
                  <select class="form-select" id="role" required>
                    <option value="">-- Chọn vai trò --</option>
                    <option value="admin">Quản trị viên</option>
                    <option value="lecturer">Giảng viên</option>
                    <option value="hod">Trưởng khoa</option>
                    <option value="aa">Phòng Đào tạo</option>
                    <option value="student">Sinh viên</option>
                  </select>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="password" class="form-label">Mật khẩu <span class="text-danger">*</span></label>
                  <input type="password" class="form-control" id="password" required placeholder="Tối thiểu 6 ký tự" minlength="6">
                  <small class="text-muted">Tối thiểu 6 ký tự</small>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="confirmPassword" class="form-label">Xác nhận mật khẩu <span class="text-danger">*</span></label>
                  <input type="password" class="form-control" id="confirmPassword" required placeholder="Nhập lại mật khẩu">
                </div>
              </div>
              
              <div class="mb-3">
                <label for="is_active" class="form-label">Trạng thái</label>
                <select class="form-select" id="is_active">
                  <option value="true">Đang hoạt động</option>
                  <option value="false">Không hoạt động</option>
                </select>
              </div>
              
              <h6 class="fw-semibold mt-4 mb-3" id="lecturerSection">Thông tin học thuật</h6>
              <div class="row" id="lecturerFields1">
                <div class="col-md-6 mb-3">
                  <label for="degree" class="form-label">Học vị</label>
                  <select class="form-select" id="degree">
                    <option value="">-- Chọn học vị --</option>
                    <option value="Cử nhân">Cử nhân</option>
                    <option value="Thạc sĩ">Thạc sĩ</option>
                    <option value="Tiến sĩ">Tiến sĩ</option>
                    <option value="Giáo sư">Giáo sư</option>
                    <option value="Phó Giáo sư">Phó Giáo sư</option>
                  </select>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="title" class="form-label">Chức danh</label>
                  <input type="text" class="form-control" id="title" placeholder="VD: Giảng viên chính, Phó giáo sư...">
                </div>
              </div>
              
              <div class="row" id="lecturerFields2">
                <div class="col-md-6 mb-3">
                  <label for="department" class="form-label">Khoa/Bộ môn</label>
                  <select class="form-select" id="department">
                    <option value="">-- Chọn khoa --</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="specialization" class="form-label">Chuyên ngành</label>
                  <input type="text" class="form-control" id="specialization" placeholder="VD: Khoa học máy tính, AI...">
                </div>
              </div>
              
              <h6 class="fw-semibold mt-4 mb-3" id="contactSection">Thông tin liên hệ</h6>
              <div class="row" id="contactFields">
                <div class="col-md-6 mb-3">
                  <label for="phone" class="form-label">Số điện thoại</label>
                  <input type="text" class="form-control" id="phone" placeholder="+84...">
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="office_location" class="form-label">Phòng làm việc</label>
                  <input type="text" class="form-control" id="office_location" placeholder="VD: Phòng A101, Tòa nhà B">
                </div>
              </div>
              
              <h6 class="fw-semibold mt-4 mb-3" id="researchSection">Thông tin nghiên cứu & giảng dạy</h6>
              <div class="mb-3" id="researchFields1">
                <label for="research_interests" class="form-label">Lĩnh vực nghiên cứu</label>
                <textarea class="form-control" id="research_interests" rows="3" placeholder="Nhập lĩnh vực nghiên cứu (VD: Machine Learning, NLP, Computer Vision...)"></textarea>
              </div>
              
              <div class="mb-3" id="researchFields2">
                <label for="teaching_subjects" class="form-label">Môn giảng dạy</label>
                <textarea class="form-control" id="teaching_subjects" rows="3" placeholder="Nhập các môn giảng dạy (VD: Lập trình Python, Cấu trúc dữ liệu...)"></textarea>
              </div>
              
              <div class="row" id="researchFields3">
                <div class="col-md-6 mb-3">
                  <label for="years_experience" class="form-label">Số năm kinh nghiệm</label>
                  <input type="number" class="form-control" id="years_experience" placeholder="0" min="0">
                </div>
              </div>
              
              <div class="mb-3" id="researchFields4">
                <label for="qualifications" class="form-label">Trình độ chuyên môn</label>
                <textarea class="form-control" id="qualifications" rows="3" placeholder="Nhập trình độ chuyên môn, chứng chỉ..."></textarea>
              </div>
              
              <div class="mb-3" id="researchFields5">
                <label for="publications" class="form-label">Công trình nghiên cứu</label>
                <textarea class="form-control" id="publications" rows="3" placeholder="Nhập danh sách công trình nghiên cứu đã công bố..."></textarea>
              </div>
              
              <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                  <i class="ti ti-check"></i> Tạo người dùng
                </button>
                <button type="reset" class="btn btn-outline-secondary">
                  <i class="ti ti-x"></i> Làm mới
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="py-6 px-6 text-center">
        <p class="mb-0 fs-4">SMD - Syllabus Management & Digitalization System | University Administration Panel | v1.0.0</p>
      </div>
    </div>
  </div>
  
  <script src="../assets/libs/jquery/dist/jquery.min.js"></script>
  <script src="../assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/sidebarmenu.js"></script>
  <script src="../assets/js/app.min.js"></script>
  <script src="../assets/libs/simplebar/dist/simplebar.js"></script>
  
  <script>
    const API_BASE_URL = 'http://127.0.0.1:8000';
    let departments = [];
    
    // Load departments from API
    async function loadDepartments() {
      const token = checkAuth();
      if (!token) return;
      
      try {
        const response = await fetch(`${API_BASE_URL}/departments/`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          departments = await response.json();
          const select = document.getElementById('department');
          
          // Populate dropdown
          departments.forEach(dept => {
            if (dept.is_active) {
              const option = document.createElement('option');
              option.value = dept.name;
              option.textContent = dept.name;
              option.dataset.code = dept.code;
              select.appendChild(option);
            }
          });
        }
      } catch (error) {
        console.error('Error loading departments:', error);
      }
    }
    
    // Check authentication
    function checkAuth() {
      const token = localStorage.getItem('access_token');
      if (!token) {
        window.location.href = 'http://localhost:3000';
        return false;
      }
      return token;
    }
    
    function logout() {
      localStorage.clear();
      window.location.href = 'http://localhost:3000/home.html';
    }
    
    // Toggle lecturer fields based on role
    function toggleLecturerFields() {
      const role = document.getElementById('role').value;
      const isLecturer = role === 'lecturer' || role === 'hod';
      
      // Get all lecturer-specific sections
      const lecturerElements = [
        'lecturerSection', 'lecturerFields1', 'lecturerFields2',
        'contactSection', 'contactFields',
        'researchSection', 'researchFields1', 'researchFields2', 
        'researchFields3', 'researchFields4', 'researchFields5'
      ];
      
      lecturerElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.style.display = isLecturer ? '' : 'none';
        }
      });
      
      // Also toggle employee_id requirement
      const employeeIdInput = document.getElementById('employee_id');
      if (isLecturer) {
        employeeIdInput.required = true;
        employeeIdInput.parentElement.querySelector('label').innerHTML = 'Mã số giảng viên <span class="text-danger">*</span>';
      } else {
        employeeIdInput.required = false;
        employeeIdInput.parentElement.querySelector('label').innerHTML = 'Mã số giảng viên';
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      checkAuth();
      await loadDepartments();
      
      // Add role change listener
      document.getElementById('role').addEventListener('change', toggleLecturerFields);
      
      // Hide lecturer fields initially
      toggleLecturerFields();
    });
    
    // Handle form submission
    document.getElementById('createUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const employee_id = document.getElementById('employee_id').value.trim();
      const fullName = document.getElementById('fullName').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const role = document.getElementById('role').value;
      const is_active = document.getElementById('is_active').value === 'true';
      
      const errorDiv = document.getElementById('errorMessage');
      const successDiv = document.getElementById('successMessage');
      const submitBtn = document.getElementById('submitBtn');
      
      // Hide previous messages
      errorDiv.classList.add('d-none');
      successDiv.classList.add('d-none');
      
      // Validate employee_id only for lecturer and hod
      const isLecturer = role === 'lecturer' || role === 'hod';
      if (isLecturer && !employee_id) {
        errorDiv.textContent = 'Mã số giảng viên là bắt buộc đối với Giảng viên/Trưởng khoa!';
        errorDiv.classList.remove('d-none');
        return;
      }
      
      // Validate passwords match
      if (password !== confirmPassword) {
        errorDiv.textContent = 'Mật khẩu xác nhận không khớp!';
        errorDiv.classList.remove('d-none');
        return;
      }
      
      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang tạo...';
      
      try {
        const token = checkAuth();
        
        const userData = {
          email,
          employee_id,
          full_name: fullName,
          password,
          role,
          is_active,
          degree: document.getElementById('degree').value || null,
          title: document.getElementById('title').value || null,
          department: document.getElementById('department').value || null,
          specialization: document.getElementById('specialization').value || null,
          phone: document.getElementById('phone').value || null,
          office_location: document.getElementById('office_location').value || null,
          research_interests: document.getElementById('research_interests').value || null,
          teaching_subjects: document.getElementById('teaching_subjects').value || null,
          years_experience: parseInt(document.getElementById('years_experience').value) || null,
          qualifications: document.getElementById('qualifications').value || null,
          publications: document.getElementById('publications').value || null
        };
        
        const response = await fetch(`${API_BASE_URL}/auth/register`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(userData)
        });
        
        if (response.ok) {
          successDiv.textContent = `Tạo người dùng ${email} thành công!`;
          successDiv.classList.remove('d-none');
          
          // Reset form
          document.getElementById('createUserForm').reset();
          
          // Redirect after 2 seconds
          setTimeout(() => {
            window.location.href = './users-list.html';
          }, 2000);
        } else {
          const error = await response.json();
          errorDiv.textContent = error.detail || 'Tạo người dùng thất bại. Vui lòng thử lại.';
          errorDiv.classList.remove('d-none');
        }
      } catch (error) {
        console.error('Error creating user:', error);
        errorDiv.textContent = 'Lỗi kết nối. Vui lòng kiểm tra backend đang chạy.';
        errorDiv.classList.remove('d-none');
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="ti ti-check"></i> Tạo người dùng';
      }
    });
    
    // Password strength indicator
    document.getElementById('password').addEventListener('input', (e) => {
      const password = e.target.value;
      if (password.length < 6) {
        e.target.classList.add('is-invalid');
        e.target.classList.remove('is-valid');
      } else {
        e.target.classList.remove('is-invalid');
        e.target.classList.add('is-valid');
      }
    });
    
    // Confirm password validation
    document.getElementById('confirmPassword').addEventListener('input', (e) => {
      const password = document.getElementById('password').value;
      const confirmPassword = e.target.value;
      
      if (confirmPassword && password !== confirmPassword) {
        e.target.classList.add('is-invalid');
        e.target.classList.remove('is-valid');
      } else if (confirmPassword) {
        e.target.classList.remove('is-invalid');
        e.target.classList.add('is-valid');
      }
    });
  </script>
</body>

</html>
