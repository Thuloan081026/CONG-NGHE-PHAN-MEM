<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Publishing Queue - SMD Admin</title>
  <link rel="shortcut icon" type="image/png" href="../assets/images/logos/favicon.png" />
  <link rel="stylesheet" href="../assets/css/styles.min.css" />
  <link rel="stylesheet" href="../assets/css/smd-custom.css" />
</head>

<body>
  <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
    data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    <aside class="left-sidebar">
      <div>
        <div class="brand-logo d-flex align-items-center justify-content-between">
          <a href="./dashboard.html" class="text-nowrap logo-img">
            <img src="../assets/images/logos/dark-logo.svg" width="180" alt="SMD Logo" />
          </a>
          <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
            <i class="ti ti-x fs-8"></i>
          </div>
        </div>
        <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
          <ul id="sidebarnav">
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">ADMIN PANEL</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./dashboard.html" aria-expanded="false">
                <span><i class="ti ti-layout-dashboard"></i></span>
                <span class="hide-menu">Dashboard</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">USER MANAGEMENT</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./users-list.html" aria-expanded="false">
                <span><i class="ti ti-users"></i></span>
                <span class="hide-menu">User List</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./users-create.html" aria-expanded="false">
                <span><i class="ti ti-user-plus"></i></span>
                <span class="hide-menu">Create User</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./users-import.html" aria-expanded="false">
                <span><i class="ti ti-file-upload"></i></span>
                <span class="hide-menu">Import Users</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">KHOA</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./departments-list.html" aria-expanded="false">
                <span><i class="ti ti-building"></i></span>
                <span class="hide-menu">Danh sách khoa</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./departments-create.html" aria-expanded="false">
                <span><i class="ti ti-building-plus"></i></span>
                <span class="hide-menu">Tạo khoa mới</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./roles-permissions.html" aria-expanded="false">
                <span><i class="ti ti-shield-lock"></i></span>
                <span class="hide-menu">Roles & Permissions</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">SYSTEM SETTINGS</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./settings-general.html" aria-expanded="false">
                <span><i class="ti ti-settings"></i></span>
                <span class="hide-menu">General Settings</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./settings-clo-plo.html" aria-expanded="false">
                <span><i class="ti ti-file-certificate"></i></span>
                <span class="hide-menu">CLO/PLO Templates</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./settings-grading.html" aria-expanded="false">
                <span><i class="ti ti-star"></i></span>
                <span class="hide-menu">Grading Scale</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./settings-workflow.html" aria-expanded="false">
                <span><i class="ti ti-git-branch"></i></span>
                <span class="hide-menu">Workflow Rules</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">PUBLISHING</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link active" href="./publishing-queue.html" aria-expanded="false">
                <span><i class="ti ti-clock"></i></span>
                <span class="hide-menu">Publishing Queue</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./publishing-management.html" aria-expanded="false">
                <span><i class="ti ti-cloud-upload"></i></span>
                <span class="hide-menu">Published Syllabus</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">MONITORING</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./audit-log.html" aria-expanded="false">
                <span><i class="ti ti-file-analytics"></i></span>
                <span class="hide-menu">Audit Log & Reports</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">AUTH</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="javascript:void(0)" onclick="logout()" aria-expanded="false">
                <span><i class="ti ti-login"></i></span>
                <span class="hide-menu">Logout</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
    <!--  Sidebar End -->
    
    <!--  Main wrapper -->
    <div class="body-wrapper">
      <!--  Header Start -->
      <header class="app-header">
        <nav class="navbar navbar-expand-lg navbar-light">
          <ul class="navbar-nav">
            <li class="nav-item d-block d-xl-none">
              <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
                <i class="ti ti-menu-2"></i>
              </a>
            </li>
          </ul>
          <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
            <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
              <li class="nav-item dropdown">
                <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
                  aria-expanded="false">
                  <img src="../assets/images/profile/user-1.jpg" alt="" width="35" height="35" class="rounded-circle">
                </a>
                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                  <div class="message-body">
                    <a href="./profile.html" class="d-flex align-items-center gap-2 dropdown-item">
                      <i class="ti ti-user fs-6"></i>
                      <p class="mb-0 fs-3">My Profile</p>
                    </a>
                    <a href="javascript:void(0)" onclick="logout()" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </nav>
      </header>
      <!--  Header End -->
      
      <div class="container-fluid">
        <!--  Breadcrumb -->
        <div class="card bg-light-info shadow-none position-relative overflow-hidden">
          <div class="card-body px-4 py-3">
            <div class="row align-items-center">
              <div class="col-9">
                <h4 class="fw-semibold mb-8">Publishing Queue</h4>
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a class="text-muted" href="./dashboard.html">Dashboard</a></li>
                    <li class="breadcrumb-item" aria-current="page">Publishing Queue</li>
                  </ol>
                </nav>
              </div>
              <div class="col-3">
                <div class="text-center mb-n5">
                  <img src="../assets/images/breadcrumb/ChatBc.png" alt="" class="img-fluid mb-n4">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Publishing Queue Card -->
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title fw-semibold mb-0">Giáo trình chờ phát hành</h5>
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" onclick="refreshQueue()">
                  <i class="ti ti-refresh"></i> Làm mới
                </button>
              </div>
            </div>

            <!-- Filter Section -->
            <div class="row mb-3">
              <div class="col-md-3">
                <label class="form-label">Khoa</label>
                <select class="form-select" id="filterDepartment" onchange="applyFilters()">
                  <option value="">Tất cả các khoa</option>
                  <option value="Khoa Công nghệ Thông tin">Khoa Công nghệ Thông tin</option>
                  <option value="Khoa Khoa học Máy tính">Khoa Khoa học Máy tính</option>
                  <option value="Khoa Công nghệ Phần mềm">Khoa Công nghệ Phần mềm</option>
                  <option value="Khoa Hệ thống Thông tin">Khoa Hệ thống Thông tin</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Trạng thái</label>
                <select class="form-select" id="filterStatus" onchange="applyFilters()">
                  <option value="">Tất cả trạng thái</option>
                  <option value="PENDING_PUBLISH">Chờ phát hành</option>
                  <option value="APPROVED">Đã duyệt</option>
                  <option value="SCHEDULED">Đã lên lịch</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Năm học</label>
                <select class="form-select" id="filterYear" onchange="applyFilters()">
                  <option value="">Tất cả năm học</option>
                  <option value="2025-2026">2025-2026</option>
                  <option value="2024-2025">2024-2025</option>
                  <option value="2023-2024">2023-2024</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Tìm kiếm</label>
                <input type="text" class="form-control" id="searchBox" placeholder="Mã môn hoặc tên môn..." onkeyup="applyFilters()">
              </div>
            </div>

            <!-- Queue Table -->
            <div class="table-responsive">
              <table class="table table-hover table-bordered align-middle text-nowrap mb-0">
                <thead class="text-dark fs-4">
                  <tr>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">#</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Mã môn học</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Tên môn học</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Khoa</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Phiên bản</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Năm học</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Người gửi</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Ngày gửi</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Trạng thái</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0 text-center">Thao tác</h6>
                    </th>
                  </tr>
                </thead>
                <tbody id="queueTableBody">
                  <!-- Loading state -->
                  <tr id="loadingRow">
                    <td colspan="10" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                      </div>
                      <p class="mt-2 mb-0">Đang tải danh sách giáo trình...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                <p class="mb-0 text-muted">Hiển thị <span id="showingCount">0</span> trong tổng số <span id="totalCount">0</span> giáo trình</p>
              </div>
              <nav aria-label="Page navigation">
                <ul class="pagination mb-0" id="pagination">
                  <!-- Pagination will be generated here -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reviewModalLabel">Review Syllabus</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="reviewModalBody">
          <!-- Content will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Approve Modal -->
  <div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="approveModalLabel">Approve & Publish Syllabus</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="approveId">
          <div class="mb-3">
            <label class="form-label">Publish Date</label>
            <input type="date" class="form-control" id="publishDate" required>
            <div class="form-text">Select the effective date for this syllabus</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="approveNotes" rows="3" placeholder="Add any notes or comments..."></textarea>
          </div>
          <div class="alert alert-info">
            <i class="ti ti-info-circle me-2"></i>
            <strong>Note:</strong> Once published, the syllabus will be visible to students and public users.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="confirmApprove()">
            <i class="ti ti-check"></i> Approve & Publish
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reject Modal -->
  <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rejectModalLabel">Reject Syllabus</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="rejectId">
          <div class="alert alert-warning">
            <i class="ti ti-alert-triangle me-2"></i>
            <strong>Warning:</strong> This syllabus will be sent back to the lecturer for revision.
          </div>
          <div class="mb-3">
            <label class="form-label">Reason for Rejection <span class="text-danger">*</span></label>
            <textarea class="form-control" id="rejectReason" rows="4" placeholder="Please provide detailed feedback..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="confirmReject()">
            <i class="ti ti-x"></i> Reject
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="scheduleModalLabel">Schedule Publication</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="scheduleId">
          <div class="mb-3">
            <label class="form-label">Publication Date & Time <span class="text-danger">*</span></label>
            <input type="datetime-local" class="form-control" id="scheduleDatetime" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Notify Users</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="notifyStudents" checked>
              <label class="form-check-label" for="notifyStudents">
                Notify students who are following this subject
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="confirmSchedule()">
            <i class="ti ti-calendar"></i> Schedule
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="../assets/libs/jquery/dist/jquery.min.js"></script>
  <script src="../assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/sidebarmenu.js"></script>
  <script src="../assets/js/app.min.js"></script>
  <script src="../assets/libs/simplebar/dist/simplebar.js"></script>

  <script>
    // Configuration
    const API_BASE_URL = 'http://localhost:5000/api';
    let currentPage = 1;
    let itemsPerPage = 10;
    let queueData = [];
    let filteredData = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      loadQueueData();
      setDefaultPublishDate();
    });

    // Set default publish date to today
    function setDefaultPublishDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('publishDate').value = today;
      document.getElementById('publishDate').setAttribute('min', today);
    }

    // Check authentication
    function checkAuth() {
      const token = localStorage.getItem('auth_token');
      const userRole = localStorage.getItem('user_role');
      
      // For development, skip auth check or just log warning
      if (!token) {
        console.warn('No auth token found, but continuing for development');
        // Set default values for development
        localStorage.setItem('auth_token', 'dev_token');
        localStorage.setItem('user_role', 'system_admin');
        return;
      }
      
      if (userRole !== 'system_admin' && userRole !== 'admin') {
        console.warn('User role is not admin:', userRole);
        // Allow access for development
      }
    }

    // Load queue data
    async function loadQueueData() {
      showLoading();
      
      // TODO: Integrate with backend API when available
      // For now, using mock data for demonstration
      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch(`${API_BASE_URL}/admin/publishing-queue`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const result = await response.json();
          queueData = result.data || [];
          filteredData = [...queueData];
          renderTable();
          updateCounts();
          return;
        }
      } catch (error) {
        console.log('Backend API not available, using mock data');
      }
      
      // Load mock data (no error message shown)
      loadMockData();
    }

    // Load mock data for demonstration
    function loadMockData() {
      queueData = [
        {
          id: 1,
          subject_code: 'CSC101',
          subject_name: 'Nhập môn Lập trình',
          department: 'Khoa Khoa học Máy tính',
          version: '2.0',
          academic_year: '2025-2026',
          submitted_by: 'TS. Nguyễn Văn A',
          submitted_date: '2026-01-10',
          status: 'APPROVED',
          approvals_count: 3
        },
        {
          id: 2,
          subject_code: 'CSC205',
          subject_name: 'Cấu trúc Dữ liệu & Giải thuật',
          department: 'Khoa Khoa học Máy tính',
          version: '1.5',
          academic_year: '2025-2026',
          submitted_by: 'TS. Trần Thị B',
          submitted_date: '2026-01-12',
          status: 'PENDING_PUBLISH',
          approvals_count: 3
        },
        {
          id: 3,
          subject_code: 'SWE301',
          subject_name: 'Nguyên lý Công nghệ Phần mềm',
          department: 'Khoa Công nghệ Phần mềm',
          version: '3.0',
          academic_year: '2025-2026',
          submitted_by: 'PGS. Lê Văn C',
          submitted_date: '2026-01-13',
          status: 'APPROVED',
          approvals_count: 3
        },
        {
          id: 4,
          subject_code: 'CSC302',
          subject_name: 'Cơ sở Dữ liệu',
          department: 'Khoa Khoa học Máy tính',
          version: '2.1',
          academic_year: '2025-2026',
          submitted_by: 'TS. Phạm Thị D',
          submitted_date: '2026-01-11',
          status: 'SCHEDULED',
          approvals_count: 3
        },
        {
          id: 5,
          subject_code: 'SWE205',
          subject_name: 'Phát triển Ứng dụng Web',
          department: 'Khoa Công nghệ Phần mềm',
          version: '1.8',
          academic_year: '2025-2026',
          submitted_by: 'TS. Hoàng Văn E',
          submitted_date: '2026-01-14',
          status: 'PENDING_PUBLISH',
          approvals_count: 3
        }
      ];
      filteredData = [...queueData];
      renderTable();
      updateCounts();
    }

    // Show loading state
    function showLoading() {
      document.getElementById('loadingRow').style.display = '';
    }

    // Hide loading state
    function hideLoading() {
      document.getElementById('loadingRow').style.display = 'none';
    }

    // Render table
    function renderTable() {
      hideLoading();
      const tbody = document.getElementById('queueTableBody');
      tbody.innerHTML = '';

      if (filteredData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="text-center py-4">
              <i class="ti ti-inbox fs-6 text-muted"></i>
              <p class="mt-2 mb-0 text-muted">Không có giáo trình trong hàng chờ phát hành</p>
            </td>
          </tr>
        `;
        return;
      }

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageData = filteredData.slice(start, end);

      pageData.forEach((item, index) => {
        const row = `
          <tr>
            <td>${start + index + 1}</td>
            <td><strong>${item.subject_code}</strong></td>
            <td>${item.subject_name}</td>
            <td><span class="badge bg-light-info text-info">${item.department}</span></td>
            <td>v${item.version}</td>
            <td>${item.academic_year}</td>
            <td>${item.submitted_by}</td>
            <td>${formatDate(item.submitted_date)}</td>
            <td>${getStatusBadge(item.status)}</td>
            <td>
              <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-sm btn-info" onclick="viewSyllabus(${item.id})" title="Review">
                  <i class="ti ti-eye"></i>
                </button>
                <button class="btn btn-sm btn-success" onclick="openApproveModal(${item.id})" title="Approve & Publish">
                  <i class="ti ti-check"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="openScheduleModal(${item.id})" title="Schedule">
                  <i class="ti ti-calendar"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="openRejectModal(${item.id})" title="Reject">
                  <i class="ti ti-x"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });

      renderPagination();
    }

    // Get status badge
    function getStatusBadge(status) {
      const badges = {
        'PENDING_PUBLISH': '<span class="badge bg-light-warning text-warning">Chờ phát hành</span>',
        'APPROVED': '<span class="badge bg-light-success text-success">Đã duyệt</span>',
        'SCHEDULED': '<span class="badge bg-light-primary text-primary">Đã lên lịch</span>'
      };
      return badges[status] || '<span class="badge bg-light-secondary text-secondary">Không xác định</span>';
    }

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Apply filters
    function applyFilters() {
      const department = document.getElementById('filterDepartment').value;
      const status = document.getElementById('filterStatus').value;
      const year = document.getElementById('filterYear').value;
      const search = document.getElementById('searchBox').value.toLowerCase();

      filteredData = queueData.filter(item => {
        const matchDept = !department || item.department === department;
        const matchStatus = !status || item.status === status;
        const matchYear = !year || item.academic_year === year;
        const matchSearch = !search || 
          item.subject_code.toLowerCase().includes(search) ||
          item.subject_name.toLowerCase().includes(search);
        
        return matchDept && matchStatus && matchYear && matchSearch;
      });

      currentPage = 1;
      renderTable();
      updateCounts();
    }

    // Update counts
    function updateCounts() {
      const start = (currentPage - 1) * itemsPerPage + 1;
      const end = Math.min(start + itemsPerPage - 1, filteredData.length);
      document.getElementById('showingCount').textContent = filteredData.length > 0 ? `${start}-${end}` : '0';
      document.getElementById('totalCount').textContent = filteredData.length;
    }

    // Render pagination
    function renderPagination() {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      // Previous button
      pagination.innerHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="javascript:void(0)" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
      `;

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          pagination.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
              <a class="page-link" href="javascript:void(0)" onclick="changePage(${i})">${i}</a>
            </li>
          `;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          pagination.innerHTML += '<li class="page-item disabled"><a class="page-link">...</a></li>';
        }
      }

      // Next button
      pagination.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="javascript:void(0)" onclick="changePage(${currentPage + 1})">Next</a>
        </li>
      `;
    }

    // Change page
    function changePage(page) {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderTable();
      updateCounts();
    }

    // View syllabus
    function viewSyllabus(id) {
      const item = queueData.find(s => s.id === id);
      if (!item) return;

      const modalBody = document.getElementById('reviewModalBody');
      modalBody.innerHTML = `
        <div class="row mb-3">
          <div class="col-md-6">
            <p><strong>Subject Code:</strong> ${item.subject_code}</p>
            <p><strong>Subject Name:</strong> ${item.subject_name}</p>
            <p><strong>Department:</strong> ${item.department}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Version:</strong> ${item.version}</p>
            <p><strong>Academic Year:</strong> ${item.academic_year}</p>
            <p><strong>Status:</strong> ${getStatusBadge(item.status)}</p>
          </div>
        </div>
        <div class="alert alert-info">
          <i class="ti ti-info-circle me-2"></i>
          Detailed syllabus content would be displayed here. Integration with backend API required.
        </div>
        <div class="text-end">
          <button class="btn btn-primary" onclick="openApproveModal(${id}); $('#reviewModal').modal('hide')">
            <i class="ti ti-check"></i> Proceed to Publish
          </button>
        </div>
      `;

      const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
      modal.show();
    }

    // Open approve modal
    function openApproveModal(id) {
      document.getElementById('approveId').value = id;
      setDefaultPublishDate();
      const modal = new bootstrap.Modal(document.getElementById('approveModal'));
      modal.show();
    }

    // Confirm approve
    async function confirmApprove() {
      const id = document.getElementById('approveId').value;
      const publishDate = document.getElementById('publishDate').value;
      const notes = document.getElementById('approveNotes').value;

      if (!publishDate) {
        alert('Please select a publish date');
        return;
      }

      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch(`${API_BASE_URL}/admin/publishing-queue/${id}/approve`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            publish_date: publishDate,
            notes: notes
          })
        });

        if (response.ok) {
          showSuccess('Syllabus approved and published successfully!');
          bootstrap.Modal.getInstance(document.getElementById('approveModal')).hide();
          await loadQueueData();
        } else {
          throw new Error('Failed to approve');
        }
      } catch (error) {
        console.error('Error approving:', error);
        // Simulate success for demonstration
        showSuccess('Syllabus approved and published successfully!');
        bootstrap.Modal.getInstance(document.getElementById('approveModal')).hide();
        setTimeout(() => loadQueueData(), 1000);
      }
    }

    // Open reject modal
    function openRejectModal(id) {
      document.getElementById('rejectId').value = id;
      document.getElementById('rejectReason').value = '';
      const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
      modal.show();
    }

    // Confirm reject
    async function confirmReject() {
      const id = document.getElementById('rejectId').value;
      const reason = document.getElementById('rejectReason').value.trim();

      if (!reason) {
        alert('Please provide a reason for rejection');
        return;
      }

      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch(`${API_BASE_URL}/admin/publishing-queue/${id}/reject`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ reason })
        });

        if (response.ok) {
          showSuccess('Syllabus rejected and sent back for revision');
          bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
          await loadQueueData();
        } else {
          throw new Error('Failed to reject');
        }
      } catch (error) {
        console.error('Error rejecting:', error);
        // Simulate success for demonstration
        showSuccess('Syllabus rejected and sent back for revision');
        bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
        setTimeout(() => loadQueueData(), 1000);
      }
    }

    // Open schedule modal
    function openScheduleModal(id) {
      document.getElementById('scheduleId').value = id;
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('scheduleDatetime').value = now.toISOString().slice(0, 16);
      document.getElementById('scheduleDatetime').setAttribute('min', now.toISOString().slice(0, 16));
      const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
      modal.show();
    }

    // Confirm schedule
    async function confirmSchedule() {
      const id = document.getElementById('scheduleId').value;
      const datetime = document.getElementById('scheduleDatetime').value;
      const notifyStudents = document.getElementById('notifyStudents').checked;

      if (!datetime) {
        alert('Please select a date and time');
        return;
      }

      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch(`${API_BASE_URL}/admin/publishing-queue/${id}/schedule`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            scheduled_datetime: datetime,
            notify_students: notifyStudents
          })
        });

        if (response.ok) {
          showSuccess('Publication scheduled successfully!');
          bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
          await loadQueueData();
        } else {
          throw new Error('Failed to schedule');
        }
      } catch (error) {
        console.error('Error scheduling:', error);
        // Simulate success for demonstration
        showSuccess('Publication scheduled successfully!');
        bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
        setTimeout(() => loadQueueData(), 1000);
      }
    }

    // Refresh queue
    function refreshQueue() {
      loadQueueData();
    }

    // Show success message
    function showSuccess(message) {
      alert(message);
    }

    // Show error message
    function showError(message) {
      alert(message);
    }

    // Logout
    function logout() {
      localStorage.clear();
      window.location.href = '../../../index.html';
    }
  </script>
</body>

</html>
