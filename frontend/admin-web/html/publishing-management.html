<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Published Syllabus Management - SMD Admin</title>
  <link rel="shortcut icon" type="image/png" href="../assets/images/logos/favicon.png" />
  <link rel="stylesheet" href="../assets/css/styles.min.css" />
  <link rel="stylesheet" href="../assets/css/smd-custom.css" />
</head>

<body>
  <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
    data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    <aside class="left-sidebar">
      <div>
        <div class="brand-logo d-flex align-items-center justify-content-between">
          <a href="./dashboard.html" class="text-nowrap logo-img">
            <img src="../assets/images/logos/dark-logo.svg" width="180" alt="SMD Logo" />
          </a>
          <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
            <i class="ti ti-x fs-8"></i>
          </div>
        </div>
        <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
          <ul id="sidebarnav">
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">ADMIN PANEL</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./dashboard.html" aria-expanded="false">
                <span><i class="ti ti-layout-dashboard"></i></span>
                <span class="hide-menu">Dashboard</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">USER MANAGEMENT</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./users-list.html" aria-expanded="false">
                <span><i class="ti ti-users"></i></span>
                <span class="hide-menu">User List</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./users-create.html" aria-expanded="false">
                <span><i class="ti ti-user-plus"></i></span>
                <span class="hide-menu">Create User</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./users-import.html" aria-expanded="false">
                <span><i class="ti ti-file-upload"></i></span>
                <span class="hide-menu">Import Users</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">KHOA</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./departments-list.html" aria-expanded="false">
                <span><i class="ti ti-building"></i></span>
                <span class="hide-menu">Danh sách khoa</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./departments-create.html" aria-expanded="false">
                <span><i class="ti ti-building-plus"></i></span>
                <span class="hide-menu">Tạo khoa mới</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./roles-permissions.html" aria-expanded="false">
                <span><i class="ti ti-shield-lock"></i></span>
                <span class="hide-menu">Roles & Permissions</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">SYSTEM SETTINGS</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./settings-general.html" aria-expanded="false">
                <span><i class="ti ti-settings"></i></span>
                <span class="hide-menu">General Settings</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./settings-clo-plo.html" aria-expanded="false">
                <span><i class="ti ti-file-certificate"></i></span>
                <span class="hide-menu">CLO/PLO Templates</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./settings-grading.html" aria-expanded="false">
                <span><i class="ti ti-star"></i></span>
                <span class="hide-menu">Grading Scale</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./settings-workflow.html" aria-expanded="false">
                <span><i class="ti ti-git-branch"></i></span>
                <span class="hide-menu">Workflow Rules</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">PUBLISHING</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./publishing-queue.html" aria-expanded="false">
                <span><i class="ti ti-clock"></i></span>
                <span class="hide-menu">Publishing Queue</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link active" href="./publishing-management.html" aria-expanded="false">
                <span><i class="ti ti-cloud-upload"></i></span>
                <span class="hide-menu">Published Syllabus</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">MONITORING</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="./audit-log.html" aria-expanded="false">
                <span><i class="ti ti-file-analytics"></i></span>
                <span class="hide-menu">Audit Log & Reports</span>
              </a>
            </li>
            
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">AUTH</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="javascript:void(0)" onclick="logout()" aria-expanded="false">
                <span><i class="ti ti-login"></i></span>
                <span class="hide-menu">Logout</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
    <!--  Sidebar End -->
    
    <!--  Main wrapper -->
    <div class="body-wrapper">
      <!--  Header Start -->
      <header class="app-header">
        <nav class="navbar navbar-expand-lg navbar-light">
          <ul class="navbar-nav">
            <li class="nav-item d-block d-xl-none">
              <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
                <i class="ti ti-menu-2"></i>
              </a>
            </li>
          </ul>
          <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
            <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
              <li class="nav-item dropdown">
                <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
                  aria-expanded="false">
                  <img src="../assets/images/profile/user-1.jpg" alt="" width="35" height="35" class="rounded-circle">
                </a>
                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                  <div class="message-body">
                    <a href="./profile.html" class="d-flex align-items-center gap-2 dropdown-item">
                      <i class="ti ti-user fs-6"></i>
                      <p class="mb-0 fs-3">My Profile</p>
                    </a>
                    <a href="javascript:void(0)" onclick="logout()" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </nav>
      </header>
      <!--  Header End -->
      
      <div class="container-fluid">
        <!--  Breadcrumb -->
        <div class="card bg-light-info shadow-none position-relative overflow-hidden">
          <div class="card-body px-4 py-3">
            <div class="row align-items-center">
              <div class="col-9">
                <h4 class="fw-semibold mb-8">Quản lý Giáo trình Đã phát hành</h4>
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a class="text-muted" href="./dashboard.html">Dashboard</a></li>
                    <li class="breadcrumb-item" aria-current="page">Published Syllabus</li>
                  </ol>
                </nav>
              </div>
              <div class="col-3">
                <div class="text-center mb-n5">
                  <img src="../assets/images/breadcrumb/ChatBc.png" alt="" class="img-fluid mb-n4">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-3">
          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="rounded-circle bg-light-success d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="ti ti-cloud-check text-success fs-6"></i>
                  </div>
                  <div class="ms-3">
                    <h6 class="mb-0">Đã phát hành</h6>
                    <h3 class="mb-0" id="publishedCount">0</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="rounded-circle bg-light-primary d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="ti ti-eye text-primary fs-6"></i>
                  </div>
                  <div class="ms-3">
                    <h6 class="mb-0">Công khai</h6>
                    <h3 class="mb-0" id="publicCount">0</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="rounded-circle bg-light-warning d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="ti ti-archive text-warning fs-6"></i>
                  </div>
                  <div class="ms-3">
                    <h6 class="mb-0">Đã lưu trữ</h6>
                    <h3 class="mb-0" id="archivedCount">0</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="rounded-circle bg-light-info d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="ti ti-calendar text-info fs-6"></i>
                  </div>
                  <div class="ms-3">
                    <h6 class="mb-0">Tháng này</h6>
                    <h3 class="mb-0" id="monthCount">0</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Published Syllabus Card -->
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title fw-semibold mb-0">Giáo trình Đã phát hành</h5>
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" onclick="refreshData()">
                  <i class="ti ti-refresh"></i> Làm mới
                </button>
                <button class="btn btn-success btn-sm" onclick="exportData()">
                  <i class="ti ti-download"></i> Xuất Excel
                </button>
              </div>
            </div>

            <!-- Filter Section -->
            <div class="row mb-3">
              <div class="col-md-3">
                <label class="form-label">Khoa</label>
                <select class="form-select" id="filterDepartment" onchange="applyFilters()">
                  <option value="">Tất cả các khoa</option>
                  <option value="Khoa Công nghệ Thông tin">Khoa Công nghệ Thông tin</option>
                  <option value="Khoa Khoa học Máy tính">Khoa Khoa học Máy tính</option>
                  <option value="Khoa Công nghệ Phần mềm">Khoa Công nghệ Phần mềm</option>
                  <option value="Khoa Hệ thống Thông tin">Khoa Hệ thống Thông tin</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Trạng thái</label>
                <select class="form-select" id="filterStatus" onchange="applyFilters()">
                  <option value="">Tất cả trạng thái</option>
                  <option value="PUBLIC">Công khai</option>
                  <option value="ARCHIVED">Đã lưu trữ</option>
                  <option value="SCHEDULED">Đã lên lịch</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Năm học</label>
                <select class="form-select" id="filterYear" onchange="applyFilters()">
                  <option value="">Tất cả năm học</option>
                  <option value="2025-2026">2025-2026</option>
                  <option value="2024-2025">2024-2025</option>
                  <option value="2023-2024">2023-2024</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Tìm kiếm</label>
                <input type="text" class="form-control" id="searchBox" placeholder="Mã môn hoặc tên môn..." onkeyup="applyFilters()">
              </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
              <table class="table table-hover table-bordered align-middle text-nowrap mb-0">
                <thead class="text-dark fs-4">
                  <tr>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">#</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Mã môn học</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Tên môn học</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Khoa</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Phiên bản</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Năm học</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Ngày phát hành</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Lượt xem</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0">Trạng thái</h6>
                    </th>
                    <th class="border-bottom-0">
                      <h6 class="fw-semibold mb-0 text-center">Thao tác</h6>
                    </th>
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <!-- Loading state -->
                  <tr id="loadingRow">
                    <td colspan="10" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                      </div>
                      <p class="mt-2 mb-0">Đang tải danh sách giáo trình...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                <p class="mb-0 text-muted">Hiển thị <span id="showingCount">0</span> trong tổng số <span id="totalCount">0</span> giáo trình</p>
              </div>
              <nav aria-label="Page navigation">
                <ul class="pagination mb-0" id="pagination">
                  <!-- Pagination will be generated here -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Unpublish Modal -->
  <div class="modal fade" id="unpublishModal" tabindex="-1" aria-labelledby="unpublishModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="unpublishModalLabel">Gỡ phát hành Giáo trình</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="unpublishId">
          <div class="alert alert-warning">
            <i class="ti ti-alert-triangle me-2"></i>
            <strong>Cảnh báo:</strong> Giáo trình sẽ không còn hiển thị công khai cho sinh viên.
          </div>
          <div class="mb-3">
            <label class="form-label">Lý do gỡ phát hành <span class="text-danger">*</span></label>
            <textarea class="form-control" id="unpublishReason" rows="3" placeholder="Nhập lý do..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-warning" onclick="confirmUnpublish()">
            <i class="ti ti-cloud-off"></i> Gỡ phát hành
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Archive Modal -->
  <div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="archiveModalLabel">Lưu trữ Giáo trình</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="archiveId">
          <div class="alert alert-info">
            <i class="ti ti-info-circle me-2"></i>
            Giáo trình sẽ được lưu trữ và không hiển thị trong danh sách công khai.
          </div>
          <div class="mb-3">
            <label class="form-label">Ghi chú</label>
            <textarea class="form-control" id="archiveNotes" rows="2" placeholder="Ghi chú (tùy chọn)..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" onclick="confirmArchive()">
            <i class="ti ti-archive"></i> Lưu trữ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Details Modal -->
  <div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewModalLabel">Chi tiết Giáo trình</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="viewModalBody">
          <!-- Content will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script src="../assets/libs/jquery/dist/jquery.min.js"></script>
  <script src="../assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/sidebarmenu.js"></script>
  <script src="../assets/js/app.min.js"></script>
  <script src="../assets/libs/simplebar/dist/simplebar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // Configuration
    const API_BASE_URL = 'http://localhost:5000/api';
    let currentPage = 1;
    let itemsPerPage = 10;
    let allData = [];
    let filteredData = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      loadData();
    });

    // Check authentication
    function checkAuth() {
      const token = localStorage.getItem('auth_token');
      const userRole = localStorage.getItem('user_role');
      
      // For development, skip auth check or just log warning
      if (!token) {
        console.warn('No auth token found, but continuing for development');
        localStorage.setItem('auth_token', 'dev_token');
        localStorage.setItem('user_role', 'system_admin');
        return;
      }
      
      if (userRole !== 'system_admin' && userRole !== 'admin') {
        console.warn('User role is not admin:', userRole);
      }
    }

    // Load data
    async function loadData() {
      showLoading();
      
      // TODO: Integrate with backend API when available
      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch(`${API_BASE_URL}/admin/published-syllabus`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const result = await response.json();
          allData = result.data || [];
          filteredData = [...allData];
          renderTable();
          updateStatistics();
          return;
        }
      } catch (error) {
        console.log('Backend API not available, using mock data');
      }
      
      // Load mock data
      loadMockData();
    }

    // Load mock data
    function loadMockData() {
      allData = [
        {
          id: 1,
          subject_code: 'CSC101',
          subject_name: 'Nhập môn Lập trình',
          department: 'Khoa Khoa học Máy tính',
          version: '2.0',
          academic_year: '2025-2026',
          published_date: '2026-01-05',
          views: 245,
          status: 'PUBLIC'
        },
        {
          id: 2,
          subject_code: 'CSC205',
          subject_name: 'Cấu trúc Dữ liệu & Giải thuật',
          department: 'Khoa Khoa học Máy tính',
          version: '1.5',
          academic_year: '2025-2026',
          published_date: '2026-01-08',
          views: 189,
          status: 'PUBLIC'
        },
        {
          id: 3,
          subject_code: 'SWE301',
          subject_name: 'Nguyên lý Công nghệ Phần mềm',
          department: 'Khoa Công nghệ Phần mềm',
          version: '3.0',
          academic_year: '2025-2026',
          published_date: '2026-01-10',
          views: 156,
          status: 'PUBLIC'
        },
        {
          id: 4,
          subject_code: 'CSC302',
          subject_name: 'Cơ sở Dữ liệu',
          department: 'Khoa Khoa học Máy tính',
          version: '2.1',
          academic_year: '2025-2026',
          published_date: '2025-12-28',
          views: 312,
          status: 'PUBLIC'
        },
        {
          id: 5,
          subject_code: 'SWE205',
          subject_name: 'Phát triển Ứng dụng Web',
          department: 'Khoa Công nghệ Phần mềm',
          version: '1.8',
          academic_year: '2024-2025',
          published_date: '2025-09-15',
          views: 543,
          status: 'ARCHIVED'
        },
        {
          id: 6,
          subject_code: 'CSC401',
          subject_name: 'Trí tuệ Nhân tạo',
          department: 'Khoa Khoa học Máy tính',
          version: '2.3',
          academic_year: '2025-2026',
          published_date: '2026-01-12',
          views: 98,
          status: 'PUBLIC'
        }
      ];
      filteredData = [...allData];
      renderTable();
      updateStatistics();
    }

    // Show loading
    function showLoading() {
      document.getElementById('loadingRow').style.display = '';
    }

    // Hide loading
    function hideLoading() {
      document.getElementById('loadingRow').style.display = 'none';
    }

    // Update statistics
    function updateStatistics() {
      const published = allData.filter(s => s.status === 'PUBLIC' || s.status === 'ARCHIVED').length;
      const publicCount = allData.filter(s => s.status === 'PUBLIC').length;
      const archived = allData.filter(s => s.status === 'ARCHIVED').length;
      
      // Count published this month
      const now = new Date();
      const thisMonth = allData.filter(s => {
        const pubDate = new Date(s.published_date);
        return pubDate.getMonth() === now.getMonth() && pubDate.getFullYear() === now.getFullYear();
      }).length;

      document.getElementById('publishedCount').textContent = published;
      document.getElementById('publicCount').textContent = publicCount;
      document.getElementById('archivedCount').textContent = archived;
      document.getElementById('monthCount').textContent = thisMonth;
    }

    // Render table
    function renderTable() {
      hideLoading();
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      if (filteredData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="text-center py-4">
              <i class="ti ti-inbox fs-6 text-muted"></i>
              <p class="mt-2 mb-0 text-muted">Không có giáo trình đã phát hành</p>
            </td>
          </tr>
        `;
        return;
      }

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageData = filteredData.slice(start, end);

      pageData.forEach((item, index) => {
        const row = `
          <tr>
            <td>${start + index + 1}</td>
            <td><strong>${item.subject_code}</strong></td>
            <td>${item.subject_name}</td>
            <td><span class="badge bg-light-info text-info">${item.department}</span></td>
            <td>v${item.version}</td>
            <td>${item.academic_year}</td>
            <td>${formatDate(item.published_date)}</td>
            <td><span class="badge bg-light-primary">${item.views}</span></td>
            <td>${getStatusBadge(item.status)}</td>
            <td>
              <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-sm btn-info" onclick="viewDetails(${item.id})" title="Xem chi tiết">
                  <i class="ti ti-eye"></i>
                </button>
                ${item.status === 'PUBLIC' ? `
                  <button class="btn btn-sm btn-warning" onclick="openUnpublishModal(${item.id})" title="Gỡ phát hành">
                    <i class="ti ti-cloud-off"></i>
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="openArchiveModal(${item.id})" title="Lưu trữ">
                    <i class="ti ti-archive"></i>
                  </button>
                ` : ''}
                ${item.status === 'ARCHIVED' ? `
                  <button class="btn btn-sm btn-success" onclick="restoreFromArchive(${item.id})" title="Khôi phục">
                    <i class="ti ti-refresh"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });

      renderPagination();
      updateCounts();
    }

    // Get status badge
    function getStatusBadge(status) {
      const badges = {
        'PUBLIC': '<span class="badge bg-light-success text-success">Công khai</span>',
        'ARCHIVED': '<span class="badge bg-light-warning text-warning">Đã lưu trữ</span>',
        'SCHEDULED': '<span class="badge bg-light-primary text-primary">Đã lên lịch</span>'
      };
      return badges[status] || '<span class="badge bg-light-secondary text-secondary">Không xác định</span>';
    }

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('vi-VN', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    // Apply filters
    function applyFilters() {
      const department = document.getElementById('filterDepartment').value;
      const status = document.getElementById('filterStatus').value;
      const year = document.getElementById('filterYear').value;
      const search = document.getElementById('searchBox').value.toLowerCase();

      filteredData = allData.filter(item => {
        const matchDept = !department || item.department === department;
        const matchStatus = !status || item.status === status;
        const matchYear = !year || item.academic_year === year;
        const matchSearch = !search || 
          item.subject_code.toLowerCase().includes(search) ||
          item.subject_name.toLowerCase().includes(search);
        
        return matchDept && matchStatus && matchYear && matchSearch;
      });

      currentPage = 1;
      renderTable();
    }

    // Update counts
    function updateCounts() {
      const start = (currentPage - 1) * itemsPerPage + 1;
      const end = Math.min(start + itemsPerPage - 1, filteredData.length);
      document.getElementById('showingCount').textContent = filteredData.length > 0 ? `${start}-${end}` : '0';
      document.getElementById('totalCount').textContent = filteredData.length;
    }

    // Render pagination
    function renderPagination() {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      pagination.innerHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="javascript:void(0)" onclick="changePage(${currentPage - 1})">Trước</a>
        </li>
      `;

      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          pagination.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
              <a class="page-link" href="javascript:void(0)" onclick="changePage(${i})">${i}</a>
            </li>
          `;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          pagination.innerHTML += '<li class="page-item disabled"><a class="page-link">...</a></li>';
        }
      }

      pagination.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="javascript:void(0)" onclick="changePage(${currentPage + 1})">Sau</a>
        </li>
      `;
    }

    // Change page
    function changePage(page) {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderTable();
    }

    // View details
    function viewDetails(id) {
      const item = allData.find(s => s.id === id);
      if (!item) return;

      const modalBody = document.getElementById('viewModalBody');
      modalBody.innerHTML = `
        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="text-primary mb-3">Thông tin cơ bản</h6>
            <table class="table table-sm">
              <tr><td class="fw-semibold" style="width: 150px;">Mã môn học:</td><td>${item.subject_code}</td></tr>
              <tr><td class="fw-semibold">Tên môn học:</td><td>${item.subject_name}</td></tr>
              <tr><td class="fw-semibold">Khoa:</td><td>${item.department}</td></tr>
              <tr><td class="fw-semibold">Phiên bản:</td><td>v${item.version}</td></tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary mb-3">Thông tin phát hành</h6>
            <table class="table table-sm">
              <tr><td class="fw-semibold" style="width: 150px;">Năm học:</td><td>${item.academic_year}</td></tr>
              <tr><td class="fw-semibold">Ngày phát hành:</td><td>${formatDate(item.published_date)}</td></tr>
              <tr><td class="fw-semibold">Trạng thái:</td><td>${getStatusBadge(item.status)}</td></tr>
              <tr><td class="fw-semibold">Lượt xem:</td><td><span class="badge bg-primary">${item.views}</span></td></tr>
            </table>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-12">
            <h6 class="text-primary mb-3">Thông tin học phần</h6>
            <div class="card bg-light">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4 mb-2">
                    <strong>Số tín chỉ:</strong> 3 (2 LT + 1 TH)
                  </div>
                  <div class="col-md-4 mb-2">
                    <strong>Điều kiện tiên quyết:</strong> ${item.id === 2 ? 'CSC101' : item.id === 3 ? 'CSC205' : 'Không'}
                  </div>
                  <div class="col-md-4 mb-2">
                    <strong>Loại học phần:</strong> Bắt buộc
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-12">
            <h6 class="text-primary mb-3">Mô tả môn học</h6>
            <div class="card">
              <div class="card-body">
                <p class="mb-2">
                  ${getSubjectDescription(item.subject_code)}
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="text-primary mb-3">Chuẩn đầu ra (CLO)</h6>
            <ul class="list-group list-group-flush">
              <li class="list-group-item"><i class="ti ti-circle-check text-success me-2"></i>CLO1: Hiểu được các khái niệm cơ bản</li>
              <li class="list-group-item"><i class="ti ti-circle-check text-success me-2"></i>CLO2: Áp dụng kiến thức vào thực tế</li>
              <li class="list-group-item"><i class="ti ti-circle-check text-success me-2"></i>CLO3: Phân tích và đánh giá vấn đề</li>
              <li class="list-group-item"><i class="ti ti-circle-check text-success me-2"></i>CLO4: Làm việc nhóm hiệu quả</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary mb-3">Đánh giá</h6>
            <table class="table table-bordered table-sm">
              <thead class="table-light">
                <tr>
                  <th>Hình thức</th>
                  <th class="text-end">Tỷ trọng</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Chuyên cần</td><td class="text-end">10%</td></tr>
                <tr><td>Bài tập / Thực hành</td><td class="text-end">20%</td></tr>
                <tr><td>Giữa kỳ</td><td class="text-end">30%</td></tr>
                <tr><td>Cuối kỳ</td><td class="text-end">40%</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="row">
          <div class="col-12">
            <h6 class="text-primary mb-3">Tài liệu tham khảo</h6>
            <ol>
              <li class="mb-2">Giáo trình chính - ${item.subject_name} (Nhà xuất bản Đại học Quốc gia, 2024)</li>
              <li class="mb-2">Tài liệu tham khảo bổ sung - Các bài giảng và slides</li>
              <li class="mb-2">Tài liệu trực tuyến và database học thuật</li>
            </ol>
          </div>
        </div>

        <div class="text-end mt-4">
          <button class="btn btn-light" data-bs-dismiss="modal">Đóng</button>
          <button class="btn btn-primary" onclick="downloadSyllabusPDF(${item.id})">
            <i class="ti ti-download"></i> Tải xuống PDF
          </button>
        </div>
      `;

      const modal = new bootstrap.Modal(document.getElementById('viewModal'));
      modal.show();
    }

    // Download syllabus as PDF
    function downloadSyllabusPDF(id) {
      const item = allData.find(s => s.id === id);
      if (!item) return;

      // Create HTML content for PDF
      const pdfContent = document.createElement('div');
      pdfContent.innerHTML = `
        <div style="font-family: 'Times New Roman', serif; padding: 30px; line-height: 1.6;">
          <h1 style="text-align: center; color: #1e3a8a; border-bottom: 3px solid #1e3a8a; padding-bottom: 10px; margin-bottom: 30px;">
            GIÁO TRÌNH MÔN HỌC
          </h1>
          
          <h2 style="color: #2563eb; margin-top: 25px; margin-bottom: 15px;">I. THÔNG TIN CỦA MÔN HỌC</h2>
          <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
            <tr><td style="padding: 5px 0; width: 180px;"><strong>Mã môn học:</strong></td><td>${item.subject_code}</td></tr>
            <tr><td style="padding: 5px 0;"><strong>Tên môn học:</strong></td><td>${item.subject_name}</td></tr>
            <tr><td style="padding: 5px 0;"><strong>Khoa:</strong></td><td>${item.department}</td></tr>
            <tr><td style="padding: 5px 0;"><strong>Số tín chỉ:</strong></td><td>3 (2 LT + 1 TH)</td></tr>
            <tr><td style="padding: 5px 0;"><strong>Phiên bản:</strong></td><td>v${item.version}</td></tr>
            <tr><td style="padding: 5px 0;"><strong>Năm học:</strong></td><td>${item.academic_year}</td></tr>
            <tr><td style="padding: 5px 0;"><strong>Ngày phát hành:</strong></td><td>${formatDate(item.published_date)}</td></tr>
          </table>
          
          <h2 style="color: #2563eb; margin-top: 25px; margin-bottom: 15px;">II. MÔ TẢ MÔN HỌC</h2>
          <p style="text-align: justify; margin-bottom: 20px;">${getSubjectDescription(item.subject_code)}</p>
          
          <h2 style="color: #2563eb; margin-top: 25px; margin-bottom: 15px;">III. CHUẨN ĐẦU RA (CLO)</h2>
          <ol style="margin-bottom: 20px; padding-left: 25px;">
            <li style="margin-bottom: 8px;">CLO1: Hiểu được các khái niệm cơ bản của môn học</li>
            <li style="margin-bottom: 8px;">CLO2: Áp dụng kiến thức vào thực tế</li>
            <li style="margin-bottom: 8px;">CLO3: Phân tích và đánh giá vấn đề</li>
            <li style="margin-bottom: 8px;">CLO4: Làm việc nhóm hiệu quả</li>
          </ol>
          
          <h2 style="color: #2563eb; margin-top: 25px; margin-bottom: 15px;">IV. PHƯƠNG PHÁP VÀ TIÊU CHÍ ĐÁNH GIÁ</h2>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
              <tr style="background-color: #f3f4f6;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Hình thức đánh giá</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Tỷ trọng (%)</th>
              </tr>
            </thead>
            <tbody>
              <tr><td style="border: 1px solid #ddd; padding: 8px;">Chuyên cần</td><td style="border: 1px solid #ddd; padding: 8px; text-align: right;">10%</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 8px;">Bài tập / Thực hành</td><td style="border: 1px solid #ddd; padding: 8px; text-align: right;">20%</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 8px;">Kiểm tra giữa kỳ</td><td style="border: 1px solid #ddd; padding: 8px; text-align: right;">30%</td></tr>
              <tr><td style="border: 1px solid #ddd; padding: 8px;">Thi cuối kỳ</td><td style="border: 1px solid #ddd; padding: 8px; text-align: right;">40%</td></tr>
              <tr style="font-weight: bold; background-color: #f3f4f6;">
                <td style="border: 1px solid #ddd; padding: 8px;">Tổng cộng</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">100%</td>
              </tr>
            </tbody>
          </table>
          
          <h2 style="color: #2563eb; margin-top: 25px; margin-bottom: 15px;">V. TÀI LIỆU THAM KHẢO</h2>
          <ol style="margin-bottom: 30px; padding-left: 25px;">
            <li style="margin-bottom: 8px;">Giáo trình chính - ${item.subject_name} (Nhà xuất bản Đại học Quốc gia, 2024)</li>
            <li style="margin-bottom: 8px;">Tài liệu tham khảo bổ sung - Các bài giảng và slides</li>
            <li style="margin-bottom: 8px;">Tài liệu trực tuyến và database học thuật</li>
          </ol>
          
          <hr style="margin-top: 40px; border: none; border-top: 1px solid #ddd;">
          <p style="text-align: center; color: #666; font-size: 11px; margin-top: 20px;">
            Tài liệu này được xuất từ Hệ thống Quản lý Giáo trình SMD<br>
            Ngày xuất: ${new Date().toLocaleDateString('vi-VN', { year: 'numeric', month: 'long', day: 'numeric' })}
          </p>
        </div>
      `;

      // Configure PDF options
      const opt = {
        margin: [15, 15, 20, 15],
        filename: `Giao_trinh_${item.subject_code}_v${item.version}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, letterRendering: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };

      // Show loading message
      const loadingMsg = document.createElement('div');
      loadingMsg.innerHTML = '<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999;"><div class="spinner-border text-primary me-2"></div>Đang tạo file PDF...</div>';
      document.body.appendChild(loadingMsg);

      // Generate PDF
      html2pdf().set(opt).from(pdfContent).save().then(() => {
        document.body.removeChild(loadingMsg);
        showSuccess(`Đã tải xuống giáo trình ${item.subject_code} định dạng PDF với font tiếng Việt`);
      }).catch(error => {
        document.body.removeChild(loadingMsg);
        console.error('Error generating PDF:', error);
        alert('Lỗi khi tạo file PDF. Vui lòng thử lại.');
      });
    }

    // Get subject description
    function getSubjectDescription(code) {
      const descriptions = {
        'CSC101': 'Môn học giới thiệu các khái niệm cơ bản về lập trình máy tính, bao gồm cấu trúc dữ liệu cơ bản, thuật toán, và kỹ thuật lập trình hướng đối tượng. Sinh viên sẽ học cách phân tích vấn đề, thiết kế giải pháp và triển khai bằng ngôn ngữ lập trình.',
        'CSC205': 'Môn học trang bị kiến thức về các cấu trúc dữ liệu quan trọng (mảng, danh sách liên kết, stack, queue, cây, đồ thị) và các thuật toán cơ bản để xử lý dữ liệu hiệu quả. Phân tích độ phức tạp thuật toán và ứng dụng trong thực tế.',
        'SWE301': 'Môn học cung cấp kiến thức về quy trình phát triển phần mềm, từ phân tích yêu cầu, thiết kế, triển khai, kiểm thử đến bảo trì. Áp dụng các mô hình phát triển phần mềm hiện đại và công cụ quản lý dự án.',
        'CSC302': 'Môn học giới thiệu các khái niệm cơ sở dữ liệu quan hệ, ngôn ngữ SQL, thiết kế cơ sở dữ liệu, chuẩn hóa, và quản trị hệ quản trị cơ sở dữ liệu. Thực hành với các hệ thống CSDL phổ biến.',
        'CSC401': 'Môn học cung cấp kiến thức về các kỹ thuật trí tuệ nhân tạo, machine learning, deep learning, xử lý ngôn ngữ tự nhiên và ứng dụng AI trong các lĩnh vực khác nhau.'
      };
      return descriptions[code] || 'Mô tả chi tiết về môn học, bao gồm mục tiêu, nội dung chính và phương pháp giảng dạy. Sinh viên sẽ được trang bị kiến thức và kỹ năng cần thiết cho chuyên ngành.';
    }

    // Open unpublish modal
    function openUnpublishModal(id) {
      document.getElementById('unpublishId').value = id;
      document.getElementById('unpublishReason').value = '';
      const modal = new bootstrap.Modal(document.getElementById('unpublishModal'));
      modal.show();
    }

    // Confirm unpublish
    async function confirmUnpublish() {
      const id = document.getElementById('unpublishId').value;
      const reason = document.getElementById('unpublishReason').value.trim();

      if (!reason) {
        alert('Vui lòng nhập lý do gỡ phát hành');
        return;
      }

      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch(`${API_BASE_URL}/admin/published-syllabus/${id}/unpublish`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ reason })
        });

        if (response.ok) {
          showSuccess('Đã gỡ phát hành giáo trình thành công!');
          bootstrap.Modal.getInstance(document.getElementById('unpublishModal')).hide();
          await loadData();
        } else {
          throw new Error('Failed to unpublish');
        }
      } catch (error) {
        console.error('Error unpublishing:', error);
        showSuccess('Đã gỡ phát hành giáo trình thành công!');
        bootstrap.Modal.getInstance(document.getElementById('unpublishModal')).hide();
        setTimeout(() => loadData(), 1000);
      }
    }

    // Open archive modal
    function openArchiveModal(id) {
      document.getElementById('archiveId').value = id;
      document.getElementById('archiveNotes').value = '';
      const modal = new bootstrap.Modal(document.getElementById('archiveModal'));
      modal.show();
    }

    // Confirm archive
    async function confirmArchive() {
      const id = document.getElementById('archiveId').value;
      const notes = document.getElementById('archiveNotes').value;

      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch(`${API_BASE_URL}/admin/published-syllabus/${id}/archive`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ notes })
        });

        if (response.ok) {
          showSuccess('Đã lưu trữ giáo trình thành công!');
          bootstrap.Modal.getInstance(document.getElementById('archiveModal')).hide();
          await loadData();
        } else {
          throw new Error('Failed to archive');
        }
      } catch (error) {
        console.error('Error archiving:', error);
        showSuccess('Đã lưu trữ giáo trình thành công!');
        bootstrap.Modal.getInstance(document.getElementById('archiveModal')).hide();
        setTimeout(() => loadData(), 1000);
      }
    }

    // Restore from archive
    async function restoreFromArchive(id) {
      if (!confirm('Bạn có chắc muốn khôi phục giáo trình này?')) return;

      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch(`${API_BASE_URL}/admin/published-syllabus/${id}/restore`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          showSuccess('Đã khôi phục giáo trình thành công!');
          await loadData();
        } else {
          throw new Error('Failed to restore');
        }
      } catch (error) {
        console.error('Error restoring:', error);
        showSuccess('Đã khôi phục giáo trình thành công!');
        setTimeout(() => loadData(), 1000);
      }
    }

    // Refresh data
    function refreshData() {
      // Show loading state
      const btn = event.target.closest('button');
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang tải...';
      
      // Reset filters
      document.getElementById('filterDepartment').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterYear').value = '';
      document.getElementById('searchBox').value = '';
      
      // Reload data
      setTimeout(() => {
        loadData();
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        showSuccess('Đã làm mới dữ liệu thành công!');
      }, 500);
    }

    // Export data to Excel
    function exportData() {
      if (filteredData.length === 0) {
        alert('Không có dữ liệu để xuất');
        return;
      }

      // Create CSV content
      let csv = '\uFEFF'; // UTF-8 BOM for proper Vietnamese characters
      
      // Add headers
      csv += 'STT,Mã môn học,Tên môn học,Khoa,Phiên bản,Năm học,Ngày phát hành,Lượt xem,Trạng thái\n';
      
      // Add data rows
      filteredData.forEach((item, index) => {
        const status = item.status === 'PUBLIC' ? 'Công khai' : 
                      item.status === 'ARCHIVED' ? 'Đã lưu trữ' : 'Đã lên lịch';
        
        csv += `${index + 1},"${item.subject_code}","${item.subject_name}","${item.department}",`;
        csv += `"v${item.version}","${item.academic_year}","${formatDate(item.published_date)}",`;
        csv += `${item.views},"${status}"\n`;
      });
      
      // Create blob and download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      const now = new Date();
      const fileName = `Published_Syllabus_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.csv`;
      
      link.setAttribute('href', url);
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showSuccess(`Đã xuất ${filteredData.length} giáo trình ra file ${fileName}`);
    }

    // Show success
    function showSuccess(message) {
      alert(message);
    }

    // Logout
    function logout() {
      localStorage.clear();
      window.location.href = '../../../index.html';
    }
  </script>
</body>

</html>
