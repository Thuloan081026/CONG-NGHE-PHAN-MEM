<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>SMD - Notifications</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background: #f2f4f8;
            font-family: "Segoe UI", sans-serif;
        }

        /* ===== HEADER ===== */
        .page-header {
            background: white;
            padding: 20px 28px;
            border-radius: 14px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        /* ===== STAT CARDS ===== */
        .stat-card {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 50%, #60a5fa 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            min-height: 130px;
            position: relative;
            box-shadow: 0 12px 28px rgba(37, 99, 235, 0.35), 
                        0 0 20px rgba(37, 99, 235, 0.15);
        }

        .stat-card i {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 44px;
            opacity: 0.25;
        }

        /* ===== NOTIFICATION LIST ===== */
        .notification-item {
            background: white;
            border-radius: 14px;
            padding: 18px 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            margin-bottom: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.2);
            transform: translateY(-2px);
        }

        .badge-status {
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
        }

        .approved { background: #dcfce7; color: #166534; }
        .review { background: #fff7ed; color: #9a3412; }
        .action { background: #fee2e2; color: #991b1b; }

        /* ===== TABS ===== */
        .tabs button {
            border: 1px solid #2563eb;
            background: white;
            color: #2563eb;
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tabs button:hover {
            background: #eff6ff;
        }

        .tabs button.active {
            background: #2563eb;
            color: white;
        }
    </style>
</head>

<body>

<div class="container my-4">

    <!-- HEADER -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-1">
                <i class="fa-regular fa-bell me-2"></i>Nhận thông báo
            </h4>
            <p class="text-muted mb-0">Theo dõi các cập nhật từ hệ thống SMD</p>
        </div>

        <a href="dashboard.html" class="btn btn-outline-primary">
            <i class="fa-solid fa-arrow-left me-2"></i>Quay lại Dashboard
        </a>
    </div>

    <!-- STATS -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <h6>THÔNG BÁO MỚI</h6>
                <h2>0</h2>
                <small>Chưa đọc</small>
                <i class="fa-regular fa-bell"></i>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h6>ĐÃ XỬ LÝ</h6>
                <h2>0</h2>
                <small>Đã đọc</small>
                <i class="fa-solid fa-check"></i>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h6>CẦN HÀNH ĐỘNG</h6>
                <h2>0</h2>
                <small>Từ hệ thống</small>
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h6>TỔNG CỘNG</h6>
                <h2>0</h2>
                <small>Tất cả thông báo</small>
                <i class="fa-solid fa-clipboard-list"></i>
            </div>
        </div>
    </div>

    <!-- FILTER -->
    <div class="tabs d-flex gap-2 mb-4">
        <button class="active" onclick="filterNotifications('all')">Tất cả</button>
        <button onclick="filterNotifications('unread')">Chưa đọc</button>
        <button onclick="filterNotifications('approve')">Phê duyệt</button>
        <button onclick="filterNotifications('reject')">Yêu cầu sửa</button>

        <div class="ms-auto">
            <button class="btn btn-sm btn-outline-secondary" onclick="markAllAsRead()">
                Đánh dấu tất cả đã đọc
            </button>
        </div>
    </div>

    <!-- NOTIFICATION LIST -->
    <div id="notificationsList">
        <div class="text-center text-muted py-5">
            <i class="fa-solid fa-spinner fa-spin"></i> Đang tải thông báo...
        </div>
    </div>

</div>

<script>
    const API_URL = 'http://localhost:8000';
    const token = localStorage.getItem('access_token') || localStorage.getItem('token');
    
    if (!token) {
        window.location.href = 'home.html';
    }

    let allNotifications = [];
    let currentFilter = 'all';

    async function loadNotifications() {
        try {
            const res = await fetch(`${API_URL}/notifications?skip=0&limit=50`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) throw new Error('Failed to load notifications');

            const data = await res.json();
            allNotifications = data.items || [];
            
            // Update stats
            const unreadCount = allNotifications.filter(n => !n.is_read).length;
            const readCount = allNotifications.filter(n => n.is_read).length;
            
            document.querySelectorAll('.stat-card h2')[0].textContent = unreadCount;
            document.querySelectorAll('.stat-card h2')[1].textContent = readCount;
            document.querySelectorAll('.stat-card h2')[3].textContent = allNotifications.length;

            displayNotifications();
        } catch (error) {
            console.error('Error loading notifications:', error);
            document.getElementById('notificationsList').innerHTML = `
                <div class="text-center text-danger py-5">
                    <i class="fa-solid fa-exclamation-triangle"></i> Không thể tải thông báo
                </div>
            `;
        }
    }

    function displayNotifications() {
        let filtered = allNotifications;
        
        if (currentFilter === 'unread') {
            filtered = allNotifications.filter(n => !n.is_read);
        } else if (currentFilter !== 'all') {
            filtered = allNotifications.filter(n => n.notification_type === currentFilter);
        }

        const container = document.getElementById('notificationsList');

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fa-solid fa-inbox"></i> Không có thông báo
                </div>
            `;
            return;
        }

        let html = '';
        filtered.forEach(notif => {
            const timeAgo = getTimeAgo(new Date(notif.created_at));
            const badgeClass = getBadgeClass(notif.notification_type);
            const badgeText = getBadgeText(notif.notification_type);
            const unreadClass = notif.is_read ? '' : ' border-start border-primary border-3';

            html += `
                <div class="notification-item${unreadClass}" onclick="markAsRead(${notif.id})">
                    <div>
                        <strong>${notif.title}</strong>
                        <div class="text-muted">${notif.message}</div>
                        <small class="text-muted">${timeAgo}</small>
                    </div>
                    <span class="badge-status ${badgeClass}">${badgeText}</span>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function filterNotifications(type) {
        currentFilter = type;
        document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        displayNotifications();
    }

    async function markAsRead(notifId) {
        try {
            await fetch(`${API_URL}/notifications/${notifId}/read`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            loadNotifications();
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    }

    async function markAllAsRead() {
        const unreadIds = allNotifications.filter(n => !n.is_read).map(n => n.id);
        for (const id of unreadIds) {
            await markAsRead(id);
        }
    }

    function getTimeAgo(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 60) return `${minutes} phút trước`;
        if (hours < 24) return `${hours} giờ trước`;
        if (days < 7) return `${days} ngày trước`;
        return date.toLocaleDateString('vi-VN');
    }

    function getBadgeClass(type) {
        switch (type) {
            case 'approve': return 'approved';
            case 'reject': return 'action';
            case 'update': return 'review';
            case 'follow': return 'review';
            default: return 'review';
        }
    }

    function getBadgeText(type) {
        switch (type) {
            case 'approve': return 'Đã phê duyệt';
            case 'reject': return 'Cần sửa';
            case 'update': return 'Cập nhật';
            case 'follow': return 'Theo dõi';
            default: return 'Thông báo';
        }
    }

    // Load notifications on page load
    window.addEventListener('DOMContentLoaded', loadNotifications);
</script>
</body>
</html>

