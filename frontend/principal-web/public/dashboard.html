<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Principal Dashboard - SMD System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #5e72e4;
            --secondary-color: #8965e0;
        }
        body { background: #f8f9fe; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: linear-gradient(87deg, var(--primary-color) 0, var(--secondary-color) 100%); box-shadow: 0 0 2rem 0 rgba(136,152,170,.15); }
        .sidebar { position: fixed; top: 0; left: 0; width: 250px; height: 100vh; background: white; box-shadow: 0 0 2rem 0 rgba(136,152,170,.15); padding-top: 70px; z-index: 1000; }
        .sidebar .nav-link { color: #67748e; padding: 12px 20px; transition: all 0.3s; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { background: #f6f9fc; color: var(--primary-color); border-left: 3px solid var(--primary-color); }
        .main-content { margin-left: 250px; padding: 90px 30px 30px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 0 2rem 0 rgba(136,152,170,.15); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
        .bg-gradient-primary { background: linear-gradient(87deg, #5e72e4 0, #8965e0 100%); }
        .bg-gradient-success { background: linear-gradient(87deg, #2dce89 0, #2dcecc 100%); }
        .bg-gradient-info { background: linear-gradient(87deg, #11cdef 0, #1171ef 100%); }
        .bg-gradient-warning { background: linear-gradient(87deg, #fb6340 0, #fbb140 100%); }
        .table-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 0 2rem 0 rgba(136,152,170,.15); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="#"><i class="bi bi-mortarboard-fill"></i> SMD System</a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3"><i class="bi bi-person-circle"></i> <span id="userName">Principal</span></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Đăng xuất</button>
            </div>
        </div>
    </nav>

    <div class="sidebar">
        <nav class="nav flex-column">
            <a class="nav-link active" href="dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
            <a class="nav-link" href="syllabuses.html"><i class="bi bi-file-earmark-text me-2"></i> Syllabuses</a>
            <a class="nav-link" href="approvals.html"><i class="bi bi-check-circle me-2"></i> Approvals</a>
            <a class="nav-link" href="reports.html"><i class="bi bi-bar-chart me-2"></i> Reports</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="container-fluid">
            <div class="mb-4">
                <h2 class="fw-bold">Principal Dashboard</h2>
                <p class="text-muted">Tổng quan quản lý hệ thống</p>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div><p class="text-muted mb-1">Tổng Syllabus</p><h3 class="fw-bold mb-0" id="totalSyllabuses">0</h3></div>
                            <div class="stat-icon bg-gradient-primary"><i class="bi bi-file-earmark-text"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div><p class="text-muted mb-1">Chờ Phê Duyệt</p><h3 class="fw-bold mb-0" id="pendingApprovals">0</h3></div>
                            <div class="stat-icon bg-gradient-warning"><i class="bi bi-clock-history"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div><p class="text-muted mb-1">Đã Phê Duyệt</p><h3 class="fw-bold mb-0" id="approvedCount">0</h3></div>
                            <div class="stat-icon bg-gradient-success"><i class="bi bi-check-circle"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div><p class="text-muted mb-1">Người Dùng</p><h3 class="fw-bold mb-0" id="totalUsers">0</h3></div>
                            <div class="stat-icon bg-gradient-info"><i class="bi bi-people"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-card">
                <h5 class="fw-bold mb-4">Đề Cương Chờ Phê Duyệt Cuối Cùng</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead><tr><th>Mã MH</th><th>Tên Môn Học</th><th>Giảng Viên</th><th>Trạng Thái</th><th>Ngày Tạo</th></tr></thead>
                        <tbody id="syllabusTableBody"><tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:8000';
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
            if (!token) { window.location.href = 'http://localhost:3000'; return null; }
            if (userData.full_name) document.getElementById('userName').textContent = userData.full_name;
            return token;
        }
        function logout() { localStorage.clear(); window.location.href = 'http://localhost:3000'; }
        async function loadDashboardData() {
            const token = checkAuth();
            if (!token) return;
            try {
                console.log('Fetching stats from:', `${API_URL}/api/principal/dashboard/stats`);
                const res = await fetch(`${API_URL}/api/principal/dashboard/stats`, { headers: { 'Authorization': `Bearer ${token}` } });
                console.log('Stats response status:', res.status);
                if (res.ok) {
                    const stats = await res.json();
                    console.log('Stats data:', stats);
                    document.getElementById('totalSyllabuses').textContent = stats.total_syllabuses || 0;
                    document.getElementById('pendingApprovals').textContent = stats.pending_approval || 0;
                    document.getElementById('approvedCount').textContent = stats.published || 0;
                    document.getElementById('totalUsers').textContent = stats.total_users || 0;
                }
                console.log('Fetching syllabuses from:', `${API_URL}/api/principal/dashboard/pending-syllabuses?limit=10`);
                const sRes = await fetch(`${API_URL}/api/principal/dashboard/pending-syllabuses?limit=10`, { headers: { 'Authorization': `Bearer ${token}` } });
                console.log('Syllabuses response status:', sRes.status);
                if (sRes.ok) {
                    const syllabuses = await sRes.json();
                    const tbody = document.getElementById('syllabusTableBody');
                    if (!syllabuses || syllabuses.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Chưa có đề cương chờ phê duyệt</td></tr>';
                    } else {
                        tbody.innerHTML = syllabuses.map(s => `<tr><td><strong>${s.code||'N/A'}</strong></td><td>${s.title||'N/A'}</td><td>${s.creator_name||'N/A'}</td><td><span class="badge bg-warning">${s.workflow_status||'N/A'}</span></td><td>${new Date(s.created_at).toLocaleDateString('vi-VN')}</td></tr>`).join('');
                    }
                } else {
                    console.error('Failed to fetch syllabuses:', sRes.status, sRes.statusText);
                    const errorText = await sRes.text().catch(() => 'Unknown error');
                    console.error('Error details:', errorText);
                    document.getElementById('syllabusTableBody').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Không có dữ liệu (Lỗi: ' + sRes.status + ')</td></tr>';
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('syllabusTableBody').innerHTML = `<tr><td colspan="5" class="text-center text-danger">Lỗi: ${error.message}</td></tr>`;
            }
        }
        checkAuth();
        loadDashboardData();
    </script>
</body>
</html>
