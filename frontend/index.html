<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SMD System - ƒêƒÉng nh·∫≠p</title>
  <link rel="shortcut icon" type="image/png" href="admin-web/assets/images/logos/favicon.png" />
  <link rel="stylesheet" href="admin-web/assets/css/styles.min.css" />
</head>

<body>
  <script>
    // T·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng v√†o dashboard n·∫øu ƒë√£ c√≥ token v√† role admin, √°p d·ª•ng cho c·∫£ / v√† /index.html
    async function autoRedirectDashboard() {
      const path = window.location.pathname;
      if (path === '/' || path.endsWith('/index.html')) {
        const token = localStorage.getItem('access_token');
        if (token) {
          try {
            const res = await fetch('http://localhost:8000/users/me', {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
              const user = await res.json();
              const dashboardMap = {
                'admin': 'admin-web/dashboard-interactive.html',
                'hod': 'hod-web/dashboard.html',
                'academic_affairs': 'academic-affairs-web/dashboard-interactive.html',
                'aa': 'academic-affairs-web/dashboard-interactive.html',
                'lecturer': 'lecturer-web/dashboard.html',
                'student': 'student-web/dashboard.html',
                'principal': 'principal-web/dashboard.html',
                'reviewer': 'reviewer-web/dashboard.html',
                'user': 'user-web/dashboard.html'
              };
              const redirectUrl = dashboardMap[user.role];
              if (redirectUrl) {
                window.location.replace(redirectUrl);
                return;
              }
            }
          } catch (e) {}
        }
        // Kh√¥ng c·∫ßn redirect v√¨ server t·ª± ƒë·ªông serve index.html khi ·ªü /
      }
    }
    autoRedirectDashboard();
  </script>
  <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
    data-sidebar-position="fixed" data-header-position="fixed">
    <div class="position-relative overflow-hidden radial-gradient min-vh-100 d-flex align-items-center justify-content-center">
      <div class="d-flex align-items-center justify-content-center w-100">
        <div class="row justify-content-center w-100">
          <div class="col-md-8 col-lg-6 col-xxl-3">
            <div class="card mb-0">
              <div class="card-body">
                <a href="#" class="text-nowrap logo-img text-center d-block py-3 w-100">
                  <h2 class="fw-bold text-primary">üéì SMD System</h2>
                </a>
                <p class="text-center mb-4">H·ªá th·ªëng Qu·∫£n l√Ω ƒê·ªÅ c∆∞∆°ng M√¥n h·ªçc</p>
                
                <div id="alertBox"></div>

                <form id="loginForm" onsubmit="handleLogin(event)">
                  <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" required autocomplete="off" name="email_fake">
                  </div>
                  <div class="mb-4">
                    <label for="password" class="form-label">M·∫≠t kh·∫©u</label>
                    <input type="password" class="form-control" id="password" required autocomplete="off" name="password_fake">
                  </div>
                  <button type="submit" id="btnLogin" class="btn btn-primary w-100 py-8 fs-4 mb-4 rounded-2">
                    ƒêƒÉng nh·∫≠p
                  </button>
                  
                  
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="admin-web/assets/libs/jquery/dist/jquery.min.js"></script>
  <script src="admin-web/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const API_URL = 'http://localhost:8000';

    // KH√îNG t·ª± ƒë·ªông check auth khi load trang ƒë·ªÉ tr√°nh redirect loop
    // Ch·ªâ redirect sau khi user login th√†nh c√¥ng
    window.addEventListener('DOMContentLoaded', () => {
      // Kh√¥ng l√†m g√¨ c·∫£ - ch·ªâ hi·ªÉn th·ªã form login
    });

    async function checkExistingAuth(token) {
      try {
        const response = await fetch(`${API_URL}/users/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const userData = await response.json();
          redirectToDashboard(userData);
        } else {
          localStorage.clear();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        localStorage.clear();
      }
    }

    async function handleLogin(event) {
      event.preventDefault();

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const btnLogin = document.getElementById('btnLogin');

      btnLogin.disabled = true;
      btnLogin.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang ƒëƒÉng nh·∫≠p...';

      try {
        const response = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: email,
            password: password
          })
        });

        if (response.ok) {
          const data = await response.json();

          // Store tokens if present (backend may use different key casing)
          const accessToken = data.access_token || data.accessToken || data.access || '';
          const refreshToken = data.refresh_token || data.refreshToken || data.refresh || '';
          if (accessToken) localStorage.setItem('access_token', accessToken);
          if (refreshToken) localStorage.setItem('refresh_token', refreshToken);

          // Some backends return user object inside the login response. Use it if available
          let userData = data.user || data.user_data || null;

          // Otherwise request /users/me using the access token
          if (!userData) {
            const tokenToUse = accessToken || localStorage.getItem('access_token');
            const userResponse = await fetch(`${API_URL}/users/me`, {
              headers: { 'Authorization': `Bearer ${tokenToUse}` }
            });

            if (userResponse.ok) {
              userData = await userResponse.json();
            } else {
              throw new Error('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi d√πng');
            }
          }

          console.log('User data received:', userData);
          localStorage.setItem('user_data', JSON.stringify(userData));

          showAlert('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...', 'success');
          console.log('About to redirect with user data:', userData);

          // Re-enable button (in case redirect is slow) so UI isn't stuck
          btnLogin.disabled = false;
          btnLogin.innerHTML = 'ƒêƒÉng nh·∫≠p';

          setTimeout(() => {
            try {
              console.log('Calling redirectToDashboard...');
              redirectToDashboard(userData);
            } catch (err) {
              console.error('Redirect failed:', err);
              showAlert('‚ö†Ô∏è Chuy·ªÉn h∆∞·ªõng th·∫•t b·∫°i, vui l√≤ng m·ªü dashboard th·ªß c√¥ng.', 'warning');
            }
          }, 600);
        } else {
          const errorData = await response.json().catch(() => ({ detail: 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i' }));
          const errorMessage = typeof errorData.detail === 'string'
            ? errorData.detail
            : JSON.stringify(errorData.detail) || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i';
          throw new Error(errorMessage);
        }
      } catch (error) {
        console.error('Login error:', error);
        const errorMsg = error.message || 'C√≥ l·ªói x·∫£y ra khi ƒëƒÉng nh·∫≠p';
        showAlert('‚ùå ' + errorMsg, 'danger');
        btnLogin.disabled = false;
        btnLogin.innerHTML = 'ƒêƒÉng nh·∫≠p';
      }
    }

    function redirectToDashboard(userData) {
      console.log('User data:', userData);
      console.log('User role:', userData.role);
      console.log('User role type:', typeof userData.role);
      console.log('User role repr:', JSON.stringify(userData.role));
      
      // Build dashboard URLs - M·ªói dashboard ch·∫°y tr√™n port ri√™ng
      const dashboardMap = {
        'admin': 'http://localhost:3001/dashboard.html',
        'lecturer': 'http://localhost:3002/dashboard.html',
        'hod': 'http://localhost:3002/dashboard.html',
        'academic_affairs': 'http://localhost:3002/dashboard.html',
        'student': 'http://localhost:3002/dashboard.html',
        'principal': 'http://localhost:3003/dashboard.html',
        'reviewer': 'http://localhost:3002/dashboard.html',
        'user': 'http://localhost:3002/dashboard.html',
        'aa': 'http://localhost:3002/dashboard.html'
      };

      console.log('Dashboard map keys:', Object.keys(dashboardMap));
      const redirectUrl = dashboardMap[userData.role];
      console.log('Redirect URL:', redirectUrl);
      
      if (redirectUrl) {
        console.log('Redirecting to:', redirectUrl);
        window.location.replace(redirectUrl);
        return;
      }
      
      console.error('Role not found in map!');
      showAlert('‚ö†Ô∏è Role kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£: ' + userData.role, 'warning');
    }

    function showAlert(message, type) {
      const alertBox = document.getElementById('alertBox');
      alertBox.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
    }
  </script>
</body>

</html>
