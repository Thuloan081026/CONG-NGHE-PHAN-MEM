<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Login Diagnostic</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #ddd;
            max-width: 1200px;
            margin: auto;
        }
        h1 { color: #4fc3f7; }
        h2 { color: #81c784; margin-top: 30px; }
        .box { background: #2d2d2d; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 3px solid #4fc3f7; }
        .success { border-left-color: #81c784; }
        .error { border-left-color: #e57373; }
        button { 
            background: #4fc3f7; 
            color: #000; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 3px; 
            cursor: pointer;
            margin: 5px;
            font-family: monospace;
            font-weight: bold;
        }
        button:hover { background: #29b6f6; }
        pre { 
            background: #1a1a1a; 
            padding: 10px; 
            overflow-x: auto;
            border-radius: 3px;
            font-size: 12px;
        }
        input { 
            padding: 8px; 
            width: 300px; 
            font-family: monospace;
            background: #1a1a1a;
            color: #ddd;
            border: 1px solid #4fc3f7;
            border-radius: 3px;
        }
        .status { padding: 5px 10px; border-radius: 3px; margin: 5px 0; }
        .status.ok { background: #2e7d32; }
        .status.error { background: #c62828; }
    </style>
</head>
<body>
    <h1>üîç Principal Login Diagnostic</h1>
    
    <div class="box">
        <h2>Configuration</h2>
        <p>Frontend: <code>http://localhost:3000</code></p>
        <p>Backend: <code>http://localhost:8000</code></p>
        <p>Account: <code>principal@edu.vn / principal123</code></p>
    </div>
    
    <div class="box success">
        <h2>Step 1: Manual Login Test</h2>
        <button onclick="testManualLogin()">üîë Test Login</button>
        <div id="step1Result"></div>
    </div>
    
    <div class="box success">
        <h2>Step 2: Check Page Code</h2>
        <button onclick="checkPageCode()">üìÑ Check Code</button>
        <div id="step2Result"></div>
    </div>
    
    <div class="box success">
        <h2>Step 3: Simulate Redirect</h2>
        <button onclick="simulateRedirect()">üöÄ Simulate Redirect</button>
        <div id="step3Result"></div>
    </div>

    <script>
        async function testManualLogin() {
            const resultDiv = document.getElementById('step1Result');
            resultDiv.innerHTML = '<p>Testing...</p>';
            
            try {
                const response = await fetch('http://localhost:8000/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'principal@edu.vn',
                        password: 'principal123'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Login failed: ${response.status}`);
                }
                
                const data = await response.json();
                const user = data.user;
                const role = user.role;
                
                // Save to window for later use
                window.testData = { data, user, role, token: data.access_token };
                
                const html = `
<div class="status ok">‚úÖ Login successful!</div>
<pre>
Email: ${user.email}
Role: ${role}
Full Name: ${user.full_name}
Token: ${data.access_token.substring(0, 50)}...
</pre>
                `;
                resultDiv.innerHTML = html;
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">‚ùå ${err.message}</div>`;
            }
        }
        
        function checkPageCode() {
            const resultDiv = document.getElementById('step2Result');
            
            // Fetch the index.html from server
            fetch('http://localhost:3000/index.html')
                .then(r => r.text())
                .then(html => {
                    const checks = {
                        'Principal mapping': html.includes("'principal': 'principal-web/dashboard.html'"),
                        'Debug logging': html.includes("console.log('User role type':"),
                        'Dashboard map': html.includes("const dashboardMap"),
                        'Redirect function': html.includes("function redirectToDashboard"),
                        'Auth check': html.includes("localStorage.getItem('access_token')")
                    };
                    
                    let html_result = '<h3>Code Checks:</h3>';
                    for (const [name, ok] of Object.entries(checks)) {
                        const status = ok ? '‚úÖ' : '‚ùå';
                        html_result += `<p>${status} ${name}</p>`;
                    }
                    
                    resultDiv.innerHTML = html_result;
                })
                .catch(e => {
                    resultDiv.innerHTML = `<div class="status error">‚ùå Could not fetch index.html: ${e.message}</div>`;
                });
        }
        
        function simulateRedirect() {
            const resultDiv = document.getElementById('step3Result');
            
            if (!window.testData) {
                resultDiv.innerHTML = '<div class="status error">‚ùå Run Step 1 first to get login data</div>';
                return;
            }
            
            const user = window.testData.user;
            const dashboardMap = {
                'admin': 'admin-web/html/dashboard.html',
                'lecturer': 'lecturer-web/dashboard.html',
                'hod': 'hod-web/dashboard.html',
                'academic_affairs': 'academic-affairs-web/dashboard.html',
                'student': 'student-web/dashboard.html',
                'principal': 'principal-web/dashboard.html',
                'reviewer': 'reviewer-web/dashboard.html',
                'user': 'user-web/dashboard.html'
            };
            
            const role = user.role;
            const url = dashboardMap[role];
            
            let html_result = `
<div class="status ok">Redirect Logic Test</div>
<pre>
Role from login: "${role}"
Type: ${typeof role}
Found in map: ${role in dashboardMap ? 'YES' : 'NO'}
Redirect URL: ${url}
</pre>
            `;
            
            if (url) {
                html_result += `
<button onclick="goToDashboard('${url}')">
  ‚úÖ Click to Open Dashboard
</button>

<p style="color: #aaa;">Or paste in console:</p>
<pre>localStorage.setItem('access_token', '${window.testData.token}');
window.location.href = '${url}';</pre>
                `;
            } else {
                html_result += '<div class="status error">‚ùå Role not found in dashboard map!</div>';
            }
            
            resultDiv.innerHTML = html_result;
        }
        
        function goToDashboard(url) {
            localStorage.setItem('access_token', window.testData.token);
            localStorage.setItem('user_data', JSON.stringify(window.testData.user));
            window.location.href = url;
        }
    </script>
</body>
</html>
