<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Syllabus Search & Analysis - HoD | SMD System</title>
  <link rel="shortcut icon" href="./img/svg/logo.svg" type="image/x-icon">
  <link rel="stylesheet" href="./css/style.min.css">
  <style>
    .search-container { max-width: 1400px; margin: 0 auto; }
    .search-panel { background: #fff; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .search-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .form-group { margin-bottom: 0; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #666; font-size: 13px; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .search-actions { display: flex; gap: 10px; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
    .btn-primary { background: #007bff; color: #fff; }
    .btn-secondary { background: #6c757d; color: #fff; }
    .btn-success { background: #28a745; color: #fff; }
    .results-panel { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .results-table { width: 100%; border-collapse: collapse; }
    .results-table th { background: #f8f9fa; padding: 12px; text-align: left; font-size: 13px; color: #666; border-bottom: 2px solid #dee2e6; }
    .results-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
    .results-table tr:hover { background: #f8f9fa; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .badge-approved { background: #28a745; color: #fff; }
    .badge-pending { background: #ffc107; color: #000; }
    .badge-draft { background: #6c757d; color: #fff; }
    .action-btn { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; margin-right: 5px; }
    .btn-view { background: #007bff; color: #fff; }
    .btn-compare { background: #17a2b8; color: #fff; }
    .comparison-mode { background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ffc107; }
    .selected-for-compare { background: #d1ecf1 !important; }
    .compare-panel { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); margin-top: 20px; }
    .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .compare-section { padding: 20px; background: #f8f9fa; border-radius: 6px; }
    .compare-section h3 { margin: 0 0 15px 0; color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    .diff-added { background: #d4edda; padding: 8px; border-left: 3px solid #28a745; margin: 5px 0; border-radius: 4px; }
    .diff-removed { background: #f8d7da; padding: 8px; border-left: 3px solid #dc3545; margin: 5px 0; border-radius: 4px; }
    .diff-modified { background: #fff3cd; padding: 8px; border-left: 3px solid #ffc107; margin: 5px 0; border-radius: 4px; }
    .stats-card { background: #e7f3ff; padding: 15px; border-radius: 6px; margin-top: 15px; }
    .stats-card h4 { margin: 0 0 10px 0; color: #0056b3; }
    .info-item { margin-bottom: 8px; font-size: 13px; }
    .info-item strong { color: #333; }
  </style>
</head>
<body>
  <div class="layer"></div>
  <div class="page-flex">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-start">
        <div class="sidebar-head">
          <a href="/hod-web/dashboard.html" class="logo-wrapper">
            <div class="logo-text">
              <span class="logo-title">SMD System</span>
              <span class="logo-subtitle">HoD Portal</span>
            </div>
          </a>
        </div>
        <div class="sidebar-body">
          <ul class="sidebar-body-menu">
            <li><a href="dashboard.html"><span class="icon home"></span>Dashboard</a></li>
            <li><a href="syllabus-pending.html"><span class="icon document"></span>Review Queue</a></li>
            <li><a href="collaborative-review.html"><span class="icon message"></span>Collaborative Review</a></li>
            <li><a class="active" href="syllabus-search.html"><span class="icon folder"></span>Lookup & Analysis</a></li>
          </ul>
        </div>
      </div>
    </aside>

    <div class="main-wrapper">
      <nav class="main-nav--bg">
        <div class="container main-nav">
          <div class="main-nav-start">
            <h1>üîç Syllabus Search & Analysis</h1>
          </div>
          <div class="main-nav-end">
            <button class="theme-switcher gray-circle-btn" type="button">
              <i class="sun-icon" data-feather="sun"></i>
              <i class="moon-icon" data-feather="moon"></i>
            </button>
            <div class="nav-user-wrapper">
              <button class="nav-user-btn dropdown-btn" type="button">
                <span class="nav-user-img">
                  <img src="./img/avatar/avatar-illustrated-01.png" alt="User">
                </span>
              </button>
              <ul class="users-item-dropdown nav-user-dropdown dropdown">
                <li><a href="profile.html">Profile</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
              </ul>
            </div>
          </div>
        </div>
      </nav>

      <main class="main users chart-page" id="skip-target">
        <div class="search-container">
          <!-- Search Panel -->
          <div class="search-panel">
            <h3 style="margin: 0 0 20px 0;">üîé Advanced Search</h3>
            
            <div class="search-grid">
              <div class="form-group">
                <label>Subject Code:</label>
                <input type="text" class="form-control" id="search-code" placeholder="e.g., CS201">
              </div>
              
              <div class="form-group">
                <label>Subject Name:</label>
                <input type="text" class="form-control" id="search-name" placeholder="e.g., Data Structures">
              </div>
              
              <div class="form-group">
                <label>Lecturer:</label>
                <input type="text" class="form-control" id="search-lecturer" placeholder="Lecturer name">
              </div>
              
              <div class="form-group">
                <label>Status:</label>
                <select class="form-control" id="search-status">
                  <option value="">All Status</option>
                  <option value="draft">Draft</option>
                  <option value="pending_hod_review">Pending HoD Review</option>
                  <option value="approved">Approved</option>
                  <option value="published">Published</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Academic Year:</label>
                <select class="form-control" id="search-year">
                  <option value="">All Years</option>
                  <option value="2026">2026</option>
                  <option value="2025">2025</option>
                  <option value="2024">2024</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Keywords:</label>
                <input type="text" class="form-control" id="search-keywords" placeholder="Search in content">
              </div>
            </div>

            <div class="search-actions">
              <button class="btn btn-primary" onclick="performSearch()">
                üîç Search
              </button>
              <button class="btn btn-secondary" onclick="clearSearch()">
                ‚úï Clear
              </button>
              <button class="btn btn-success" onclick="exportResults()" style="margin-left: auto;">
                üì• Export Results
              </button>
            </div>
          </div>

          <!-- Comparison Mode Banner -->
          <div class="comparison-mode" id="comparison-banner" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>üìä Comparison Mode Active</strong><br>
                <span style="font-size: 12px;">Select 2 syllabuses to compare. Currently selected: <span id="selected-count">0</span>/2</span>
              </div>
              <div>
                <button class="btn btn-success" onclick="compareSelected()" id="compare-btn" disabled>
                  ‚ÜîÔ∏è Compare Versions
                </button>
                <button class="btn btn-secondary" onclick="cancelComparison()">
                  Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- Results Panel -->
          <div class="results-panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0;">üìã Search Results</h3>
              <button class="btn btn-secondary" onclick="enableComparisonMode()">
                ‚ÜîÔ∏è Enable Comparison Mode
              </button>
            </div>

            <div id="results-info" style="margin-bottom: 15px; color: #666; font-size: 13px;">
              Ready to search...
            </div>

            <table class="results-table" id="results-table">
              <thead>
                <tr>
                  <th style="width: 40px;"><input type="checkbox" id="select-all" onclick="toggleSelectAll()" style="display: none;"></th>
                  <th>Subject Code</th>
                  <th>Subject Name</th>
                  <th>Lecturer</th>
                  <th>Version</th>
                  <th>Year</th>
                  <th>Status</th>
                  <th>Last Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="results-tbody">
                <tr>
                  <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                    Use the search form above to find syllabuses
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- Versions Modal -->
          <div id="versionsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
            <div style="max-width: 900px; margin: 50px auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
              <div style="padding: 25px; border-bottom: 2px solid #e0e0e0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0 0 10px 0;">üìö Version History</h2>
                <p id="versionsModalSubtitle" style="margin: 0; opacity: 0.9;">Loading...</p>
              </div>
              <div style="padding: 25px; max-height: 500px; overflow-y: auto;">
                <div id="versionsModalContent">Loading versions...</div>
              </div>
              <div style="padding: 20px; border-top: 2px solid #e0e0e0; text-align: right;">
                <button class="btn btn-secondary" onclick="closeVersionsModal()" style="margin-right: 10px;">ƒê√≥ng</button>
                <button id="compareVersionsBtn" class="btn btn-success" onclick="compareSelectedVersions()" disabled style="display: none;">So s√°nh ƒë√£ ch·ªçn</button>
              </div>
            </div>
          </div>
          <!-- Comparison Panel -->
          <div class="compare-panel" id="comparison-panel" style="display: none;">
            <div style="margin-bottom: 20px;">
              <h2 style="margin: 0 0 10px 0;">üìä Version Comparison Analysis</h2>
              <p style="margin: 0; color: #666;">Detailed comparison between selected syllabuses</p>
            </div>

            <div class="compare-grid" id="comparison-content">
              <!-- Comparison content will be loaded here -->
            </div>

            <div style="margin-top: 20px; text-align: center;">
              <button class="btn btn-secondary" onclick="closeComparison()">
                ‚Üê Back to Results
              </button>
              <button class="btn btn-primary" onclick="exportComparison()">
                üìÑ Export Comparison Report
              </button>
            </div>
          </div>
        </div>
      </main>

      <footer class="footer">
        <div class="container footer--flex">
          <div class="footer-start">
            <p>¬© SMD System 2026</p>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <script src="./plugins/feather.min.js"></script>
  <script src="./js/script.js"></script>
  <script>
    const API_BASE_URL = 'http://localhost:8000';
    const token = localStorage.getItem('access_token');
    let searchResults = [];
    let selectedForComparison = [];
    let comparisonMode = false;

    if (!token) {
      window.location.href = '/index.html';
    }

    // Perform search
    async function performSearch() {
      const code = document.getElementById('search-code').value;
      const name = document.getElementById('search-name').value;
      const lecturer = document.getElementById('search-lecturer').value;
      const status = document.getElementById('search-status').value;
      const year = document.getElementById('search-year').value;
      const keywords = document.getElementById('search-keywords').value;

      try {
        document.getElementById('results-info').textContent = 'Searching...';
        document.getElementById('results-tbody').innerHTML = 
          '<tr><td colspan="9" style="text-align: center; padding: 40px;">Searching...</td></tr>';

        // Build query params
        const params = new URLSearchParams();
        if (code) params.append('subject_code', code);
        if (name) params.append('subject_name', name);
        if (status) params.append('status', status);
        if (year) params.append('year', year);
        if (keywords) params.append('keywords', keywords);

        const response = await fetch(`${API_BASE_URL}/syllabuses/?${params}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

if (!response.ok) throw new Error('Search failed');

        searchResults = await response.json();
        
        // Filter by lecturer if provided
        if (lecturer) {
          searchResults = searchResults.filter(s => 
            (s.lecturer_name || '').toLowerCase().includes(lecturer.toLowerCase())
          );
        }

        displayResults();

      } catch (error) {
        console.error('Search error:', error);
        document.getElementById('results-tbody').innerHTML = 
          '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #dc3545;">Error performing search</td></tr>';
      }
    }

    // Display results
    function displayResults() {
      const tbody = document.getElementById('results-tbody');
      const infoDiv = document.getElementById('results-info');

      if (searchResults.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">No results found</td></tr>';
        infoDiv.textContent = 'No results found';
        return;
      }

      infoDiv.textContent = `Found ${searchResults.length} syllabus(es)`;

      tbody.innerHTML = searchResults.map((s, index) => {
        const statusClass = s.status === 'approved' ? 'badge-approved' : 
                           s.status === 'draft' ? 'badge-draft' : 'badge-pending';
        
        const isSelected = selectedForComparison.includes(s.id);
        
        return `
          <tr ${isSelected ? 'class="selected-for-compare"' : ''}>
            <td>
              ${comparisonMode ? `
                <input type="checkbox" 
                       onchange="toggleSelection(${s.id})" 
                       ${isSelected ? 'checked' : ''}
                       ${selectedForComparison.length >= 2 && !isSelected ? 'disabled' : ''}>
              ` : ''}
            </td>
            <td><strong>${s.subject_code || 'N/A'}</strong></td>
            <td>${s.subject_name || 'Untitled'}</td>
            <td>${s.lecturer_name || 'Unknown'}</td>
            <td>${s.version || 'v1.0'}</td>
            <td>${s.academic_year || new Date(s.created_at).getFullYear()}</td>
            <td><span class="badge ${statusClass}">${s.status || 'draft'}</span></td>
            <td>${new Date(s.updated_at || s.created_at).toLocaleDateString('vi-VN')}</td>
            <td>
              <button class="action-btn btn-view" onclick="viewSyllabus(${s.id})">üëÅÔ∏è View</button>
              <button class="action-btn btn-compare" onclick="quickCompare(${s.id})">‚ÜîÔ∏è Versions</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Clear search
    function clearSearch() {
      document.getElementById('search-code').value = '';
      document.getElementById('search-name').value = '';
      document.getElementById('search-lecturer').value = '';
      document.getElementById('search-status').value = '';
      document.getElementById('search-year').value = '';
      document.getElementById('search-keywords').value = '';
      
      searchResults = [];
      document.getElementById('results-tbody').innerHTML = 
        '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">Use the search form above to find syllabuses</td></tr>';
      document.getElementById('results-info').textContent = 'Ready to search...';
    }

    // Comparison mode
    function enableComparisonMode() {
      comparisonMode = true;
      document.getElementById('comparison-banner').style.display = 'block';
      document.getElementById('select-all').style.display = 'inline-block';
      displayResults();
    }

    function cancelComparison() {
      comparisonMode = false;
      selectedForComparison = [];
      document.getElementById('comparison-banner').style.display = 'none';
      document.getElementById('select-all').style.display = 'none';
      displayResults();
    }

    function toggleSelection(syllabusId) {
      if (selectedForComparison.includes(syllabusId)) {
        selectedForComparison = selectedForComparison.filter(id => id !== syllabusId);
      } else {
        if (selectedForComparison.length < 2) {
          selectedForComparison.push(syllabusId);
        }
      }
      
      document.getElementById('selected-count').textContent = selectedForComparison.length;
      document.getElementById('compare-btn').disabled = selectedForComparison.length !== 2;
      displayResults();
    }

    function toggleSelectAll() {
      // Implementation for select all
    }

    // Compare selected
    async function compareSelected() {
      if (selectedForComparison.length !== 2) {
        alert('Please select exactly 2 syllabuses to compare');
        return;
      }

      const [id1, id2] = selectedForComparison;
      await loadComparison(id1, id2);
    }

    // Quick compare (find all versions of a syllabus)
    async function quickCompare(syllabusId) {
      const syllabus = searchResults.find(s => s.id === syllabusId);
      if (!syllabus) return;

// Find other versions of the same subject
      const versions = searchResults.filter(s => 
        s.subject_code === syllabus.subject_code && s.id !== syllabusId
      );

      if (versions.length === 0) {
        alert('No other versions found for this subject');
        return;
      }

      // Compare with the most recent different version
      const otherVersion = versions[0];
      await loadComparison(syllabusId, otherVersion.id);
    }

    // Load comparison
    async function loadComparison(id1, id2) {
      try {
        document.getElementById('comparison-panel').style.display = 'block';
        document.getElementById('comparison-content').innerHTML = 
          '<div style="grid-column: 1/-1; text-align: center; padding: 40px;">Loading comparison...</div>';

        // Fetch both syllabuses
        const [res1, res2] = await Promise.all([
          fetch(`${API_BASE_URL}/syllabuses/${id1}`, { headers: { 'Authorization': `Bearer ${token}` } }),
          fetch(`${API_BASE_URL}/syllabuses/${id2}`, { headers: { 'Authorization': `Bearer ${token}` } })
        ]);

        const syllabus1 = await res1.json();
        const syllabus2 = await res2.json();

        displayComparison(syllabus1, syllabus2);

        // Scroll to comparison
        document.getElementById('comparison-panel').scrollIntoView({ behavior: 'smooth' });

      } catch (error) {
        console.error('Comparison error:', error);
        alert('Error loading comparison');
      }
    }

    // Display comparison
    function displayComparison(s1, s2) {
      const content = document.getElementById('comparison-content');
      
      content.innerHTML = `
        <!-- Version 1 -->
        <div class="compare-section">
          <h3>üìÑ ${s1.subject_code || 'N/A'} - ${s1.version || 'v1.0'}</h3>
          
          <div class="info-item"><strong>Subject:</strong> ${s1.subject_name || 'N/A'}</div>
          <div class="info-item"><strong>Lecturer:</strong> ${s1.lecturer_name || 'Unknown'}</div>
          <div class="info-item"><strong>Credits:</strong> ${s1.credits || 'N/A'}</div>
          <div class="info-item"><strong>Year:</strong> ${s1.academic_year || 'N/A'}</div>
          <div class="info-item"><strong>Status:</strong> ${s1.status || 'N/A'}</div>
          <div class="info-item"><strong>Last Updated:</strong> ${new Date(s1.updated_at || s1.created_at).toLocaleString('vi-VN')}</div>

          <div style="margin-top: 20px;">
            <h4 style="margin-bottom: 10px; color: #666;">Content Overview:</h4>
            <div style="background: #fff; padding: 15px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-size: 12px;">
              ${s1.description || s1.content || 'No content available'}
            </div>
          </div>

          <div class="stats-card">
            <h4>üìä Metadata</h4>
            <div class="info-item">CLOs: ${(s1.clo_plo_mapping || []).length}</div>
            <div class="info-item">Assessment Methods: ${s1.assessment_methods ? 'Defined' : 'Not defined'}</div>
            <div class="info-item">References: ${s1.references ? 'Included' : 'Not included'}</div>
          </div>
        </div>

        <!-- Version 2 -->
        <div class="compare-section">
          <h3>üìÑ ${s2.subject_code || 'N/A'} - ${s2.version || 'v1.0'}</h3>
          
          <div class="info-item"><strong>Subject:</strong> ${s2.subject_name || 'N/A'}</div>
          <div class="info-item"><strong>Lecturer:</strong> ${s2.lecturer_name || 'Unknown'}</div>
          <div class="info-item"><strong>Credits:</strong> ${s2.credits || 'N/A'}</div>
          <div class="info-item"><strong>Year:</strong> ${s2.academic_year || 'N/A'}</div>
          <div class="info-item"><strong>Status:</strong> ${s2.status || 'N/A'}</div>
          <div class="info-item"><strong>Last Updated:</strong> ${new Date(s2.updated_at || s2.created_at).toLocaleString('vi-VN')}</div>

          <div style="margin-top: 20px;">
            <h4 style="margin-bottom: 10px; color: #666;">Content Overview:</h4>
            <div style="background: #fff; padding: 15px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-size: 12px;">
              ${s2.description || s2.content || 'No content available'}
            </div>
          </div>

          <div class="stats-card">
            <h4>üìä Metadata</h4>
            <div class="info-item">CLOs: ${(s2.clo_plo_mapping || []).length}</div>
            <div class="info-item">Assessment Methods: ${s2.assessment_methods ? 'Defined' : 'Not defined'}</div>
            <div class="info-item">References: ${s2.references ? 'Included' : 'Not included'}</div>
          </div>
        </div>

        <!-- Key Differences -->
        <div style="grid-column: 1/-1; background: #fff3cd; padding: 20px; border-radius: 6px; border-left: 4px solid #ffc107;">
          <h3 style="margin: 0 0 15px 0; color: #856404;">üîç Key Differences Detected</h3>
          
          ${s1.credits !== s2.credits ? `
            <div class="diff-modified">
              <strong>Credits changed:</strong> ${s1.credits || 'N/A'} ‚Üí ${s2.credits || 'N/A'}
            </div>
          ` : ''}

          ${s1.lecturer_name !== s2.lecturer_name ? `
            <div class="diff-modified">
              <strong>Lecturer changed:</strong> ${s1.lecturer_name || 'N/A'} ‚Üí ${s2.lecturer_name || 'N/A'}
            </div>
          ` : ''}

          ${(s1.clo_plo_mapping || []).length !== (s2.clo_plo_mapping || []).length ? `
            <div class="diff-modified">
              <strong>CLO count changed:</strong> ${(s1.clo_plo_mapping || []).length} ‚Üí ${(s2.clo_plo_mapping || []).length}
            </div>
          ` : ''}

          <div class="diff-added">
            <strong>Version progression:</strong> ${s1.version || 'v1.0'} ‚Üí ${s2.version || 'v1.0'}
          </div>

          <p style="margin: 15px 0 0 0; font-size: 12px; color: #856404;">
            <em>üí° This is a simplified comparison. For detailed content diff analysis, use the AI Change Detection tool in the Review page.</em>
          </p>
        </div>
      `;
    }

    function closeComparison() {
      document.getElementById('comparison-panel').style.display = 'none';
    }

    // View syllabus
    function viewSyllabus(id) {
      window.open(`syllabus-view.html?id=${id}`, '_blank');
    }

    // Export functions
    function exportResults() {
alert('Export feature will generate CSV/PDF of search results');
    }

    function exportComparison() {
      alert('Export feature will generate comparison report');
    }

    function logout() {
      localStorage.removeItem('access_token');
      window.location.href = '/index.html';
    }

    // Auto-search on page load if there are params
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('auto_search')) {
        performSearch();
      }
    });
  </script>
</body>
</html>
